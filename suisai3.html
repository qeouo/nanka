<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title></head>
<script>
</script>
<body bgcolor="">
<input type="file" id='files' /><br>
<img id="org">
<img id="out">
</body>
<script type="text/javascript">
"use strict"
var rgb2hsv=function(hsv,r,g,b){
	var max=Math.max(r,Math.max(g,b));
	var min = Math.min(r,Math.min(g,b));
	if(max==min) hsv[0]=0;
	else if(max==r) hsv[0]=(60*(g-b)/(max-min)+360)%360
	else if(max==g) hsv[0]=(60*(b-r)/(max-min))+120;
	else if(max==b) hsv[0]=(60*(r-g)/(max-min))+240;
	if(max==0) hsv[1]=0;
	else hsv[1]=(255*((max-min)/max));
	
	hsv[2]=max;
}
var hsv2rgb=function(rgb,h,s,v){
	var f,i,p,q,t;
	i= (Math.floor(h/60.0)|0)%6;
	f=(h/60.0) - ((h/60.0)|0);
	p= (v*(1.0-(s/255.0)))|0;
	q= (v*(1.0-(s/255.0)*f))|0;
	t= (v*(1.0-(s/255.0)*(1.0-f)))|0;
	switch(i){
		case 0:rgb[0]=v;rgb[1]=t;rgb[2]=p;break;
		case 1:rgb[0]=q;rgb[1]=v;rgb[2]=p;break;
		case 2:rgb[0]=p;rgb[1]=v;rgb[2]=t;break;
		case 3:rgb[0]=p;rgb[1]=q;rgb[2]=v;break;
		case 4:rgb[0]=t;rgb[1]=p;rgb[2]=v;break;
		case 5:rgb[0]=v;rgb[1]=p;rgb[2]=q;break;
	}
}
var createNoise=function(width,height,size){
	var arr = new Array(width*height);
	var a,b,c,d,alpha=1;
	for(var i=0;i<width*height;i++)arr[i]=Math.random();
	while(size>1){
		alpha*=0.5;
		for(var i=0;i<height-size;i+=size){
			for(var j=0;j<width-size;j+=size){
				var n=i*width+j;
				a=arr[n];b=arr[n+size];c=arr[n+size*width];d=arr[n+size*(width+1)];
				arr[n+(size>>1)] = arr[n+(size>>1)]*alpha + (a+b)*0.5*(1-alpha);
				arr[n+(size>>1)*width] = arr[n+(size>>1)*width]*alpha + (a+c)*0.5*(1-alpha);
				arr[n+(size>>1)*(width+1)] = arr[n+(size>>1)*(width+1)]*alpha + (a+b+c+d)*0.25*(1-alpha);
			}
		}
		size>>=1;
	}
	return arr;
}
var shori=function(filename){
	var orgImg=	document.getElementById("org");
	orgImg.src=filename;
	orgImg.onload=function(e){
		var i,j,k,l,p;
		var a,r,g,b;
		var width=e.target.width;
		var height=e.target.height;
		var imax=width*height;
		var outdata=new Array(width*height*3);
		var preprodata =  new Array(width*height*3);
		var strokedata = preprodata.slice(0);
		var bufdata;
		var arr=new Array(3);
		var num=new Array(9);
		var tbl=[(-1-width)*3,-width*3,(1-width)*3,-3,0,3,(-1+width)*3,width*3,(1+width)*3];
		var noise = createNoise(width,height,32);
		var noise2 = createNoise(width,height,32);
		var det3 = 4/3;
		var det255=1/255;


		var c=document.createElement('canvas');
		c.setAttribute('width',width);
		c.setAttribute('height',height);
		var ctx = c.getContext('2d');
		ctx.fillStyle="fff";
		ctx.fillRect(0,0,width,height);
		ctx.drawImage(orgImg,0,0);
		var src=ctx.getImageData(0,0,width,height);
		var imagedata=src.data;
		for(i=height*width*3;i--;) preprodata[i]=imagedata[i*det3|0];

		//posterization
		for(i=0;i<imax;i++){
			p=i*3;
			rgb2hsv(arr,preprodata[p],preprodata[p+1],preprodata[p+2]);
			arr[1]=arr[1]&0xf0;
			arr[2]=arr[2]&0xf0|0x1f;
			arr[2]=Math.min(255,arr[2]+16);
			preprodata[p]=arr[0];
			preprodata[p+1]=arr[1];
			preprodata[p+2]=arr[2];
		}

		//median
		for(l=0;l<2;l++){
			bufdata = preprodata.slice(0);
			for(i=(width+1);i<imax-(width+1);i++){
				p=i*3;
				for(k=0;k<9;k++) num[k]=bufdata[p+2+tbl[k]] + k/10;
				for(k=0;k<9;k++){
					var cnt=0;
					for(j=0;j<9;j++){
						if(num[k]<num[j]) cnt++;
					}
					if(cnt==4) break;
				}
				preprodata[p+0]=bufdata[p+tbl[k]+0];
				preprodata[p+1]=bufdata[p+tbl[k]+1];
				preprodata[p+2]=bufdata[p+tbl[k]+2];
			}
		}

		for(i=outdata.length;i--;)outdata[i]=1;

		for(k=0;k<8;k++){
			//separate
			for(i=0;i<imax;i++){
				p=i*3;
				if(preprodata[p+2]<256-32*k && preprodata[p+2]>=256-32*(k+1)){

					//spotting
					g=preprodata[p+1]*(noise[i]+0.5);
					if(g>255)g=255;
					b=preprodata[p+2]*(1+noise2[i]*0.5);
					if(b>255)b=255;
					
					hsv2rgb(arr,preprodata[p],g,b);
					strokedata[p+0]=arr[0];
					strokedata[p+1]=arr[1];
					strokedata[p+2]=arr[2];
				}else{
					strokedata[p]=strokedata[p+1]=strokedata[p+2]=255;
				}	
			}
			
			//oozing
			bufdata=strokedata.slice(0);
			for(l=0;l<8;l++){
				a=bufdata; bufdata=strokedata; strokedata=a;
				for(i=width+1;i<imax-(width+1);i++){
					p=i*3;
					r=0;g=0;b=0;
					for(j=1;j<9;j+=2){
						r+=bufdata[p+tbl[j]];
						g+=bufdata[p+tbl[j]+1];
						b+=bufdata[p+tbl[j]+2];
					}
					r*=0.25;g*=0.25;b*=0.25;

					if(noise2[i]<0.4 || l==7 ){
						if(strokedata[p]+strokedata[p+1]+strokedata[p+2]>r+g+b){
							strokedata[p]=r;
							strokedata[p+1]=g;
							strokedata[p+2]=b;
						}
					}else if(noise2[i]>0.7 ){
						if(strokedata[p]+strokedata[p+1]+strokedata[p+2]<r+g+b){
							strokedata[p]=r;
							strokedata[p+1]=g;
							strokedata[p+2]=b;
						}
					}
				}
			}
			for(i=outdata.length;i--;) outdata[i]*=strokedata[i]*det255; //mult blend
		}
		for(i=outdata.length;i--;) imagedata[i*det3|0]=outdata[i]*255;
		

		ctx.putImageData(src,0,0);
		document.getElementById("out").src = c.toDataURL("image/png");
	}

}
document.getElementById('files').onchange= function(evt){
	var reader = new FileReader();
    reader.onload = function(e) {
         shori(e.target.result);
    };
    reader.readAsDataURL(evt.target.files[0]);
}
shori("test.jpg");
</script>
