<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<body style="vertical-align:top;">
<canvas id="c" width="300" height="300" style="border:solid 1px black;">
</canvas>

</body>
<script type="text/javascript">
"use strict"
var ctx,WIDTH,HEIGHT,i;

var Vec3=(function(){
	var Vec3=function(){this[0]=0;this[1]=0;this[2]=0;};
    Vec3.set=function(a,x,y,z){a[0]=x;a[1]=y;a[2]=z};
    Vec3.add=function(a,b,c){a[0]=b[0]+c[0];a[1]=b[1]+c[1];a[2]=b[2]+c[2]};
	Vec3.nrm=function(a,b){
		var s=1/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);
		a[0]*=s;a[1]*=s;a[2]*=s;
	};
    Vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2];};
	return Vec3;
})();
var Mat=(function(){
	var v = new Array(16);
	var i;
	var Mat = function(){
		this[0]=1;this[1]=0;this[2]=0;this[3]=0;
		this[4]=0;this[5]=1;this[6]=0;this[7]=0;
		this[8]=0;this[9]=0;this[10]=1;this[11]=0;
		this[12]=0;this[13]=0;this[14]=0;this[15]=1;
	};
	Mat.set = function(m,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14,a15){
		m[0]=a0;m[1]=a1;m[2]=a2;m[3]=a3;
		m[4]=a4;m[5]=a5;m[6]=a6;m[7]=a7;
		m[8]=a8;m[9]=a9;m[10]=a10;m[11]=a11;
		m[12]=a12;m[13]=a13;m[14]=a14;m[15]=a15;
	};
	Mat.dot=function(a,b,c){
		for(i=16;i--;){
			var j=i&3;
			var k=i&12;
			v[i]=b[j]*c[k] +b[4+j]*c[k+1] +b[8+j]*c[k+2] +b[12+j]*c[k+3];
		}
		for(i=16;i--;){a[i]=v[i];}
	};
	return Mat;
})();

var vertices=[0,17,-0,-41,56,71,40,56,71,82,56,0,41,56,-71,-40,56,-71,-82,56
,-0,-46,13,80,46,13,80,92,13,0,46,13,-80,-46,13,-80,-92,13,-0,-39,-55,67,38
,-55,67,78,-55,0,39,-55,-67,-38,-55,-67,-78,-55,-0,0,-55,0,0,-30,123,25,13
,102,-25,13,102,0,-47,72,25,0,80,-25,-0,80,0,24,142,18,39,121,-18,39,121,0
,37,166,20,49,127,-20,49,127,-13,44,-74,-13,46,-120,-13,-9,-142,-13,-44,-74
,-13,-25,-79,-13,-4,-121,-13,31,-108,-13,31,-77,14,44,-74,14,46,-120,14,-9
,-142,14,-44,-74,14,-25,-79,14,-4,-121,14,31,-108,14,31,-77,0,78,-0,-31,53
,53,30,53,53,62,53,0,31,53,-53,-30,53,-53,-62,53,-0,0,87,-15,15,87,0,-0,87
,15,-15,87,0,0,81,0,0,87,0];

var faces=[0,2,1,0,3,2,0,4,3,0,5,4,0,6,5,0,1,6,19,13,14,19,14,15,19,15,16
,19,16,17,19,17,18,19,18,13,39,38,32,38,33,32,38,34,33,38,37,34,37,35,34,37
,36,35,40,46,47, 40,41,46,41,42,46,42,45,46,42,43,45,43,44,45,48,50,49,48
,51,50,48,52,51,48,53,52,48,54,53,48,49,54,2,8,7,2,7,1,3,9,8,3,8,2,3,4,10
,3,10,9,5,11,10,5,10,4,6,12,11,6,11,5,1,7,12,1,12,6,8,14,13,8,13,7,9,15,14
,9,14,8,10,16,15,10,15,9,11,17,16,11,16,10,12,18,17,12,17,11,7,13,18,7,18
,12,20,21,24,20,24,23,22,25,24,22,24,21,20,23,25,20,25,22,28,22,21,28,21
,27,26,27,21,26,21,20,26,20,22,26,22,28,31,28,27,31,27,30,30,27,26,30,26
,29,31,29,26,31,26,28,46,38,39,46,39,47,40,32,33,40,33,41,41,33,34,41,34
,42,45,37,38,45,38,46,42,34,35,42,35,43,44,36,37,44,37,45,29,31,30,60,55
,56,60,56,57,60,57,58,60,58,55,55,59,56,56,59,57,57,59,58,58,59,55];

var light=new Vec3();
Vec3.set(light,-1,-1,-1);
Vec3.nrm(light,light);

var Vbuf=function(){
	this.org=new Vec3();
	this.p=new Vec3();
	this.nrm=new Vec3();
	this.l=0;
};
var vbufs=[];
for(i=0;i<vertices.length;i+=3){
	var vbuf=new Vbuf();
	vbufs.push(vbuf)
	vbuf.org[0]=vertices[i+0]
	vbuf.org[1]=vertices[i+1]
	vbuf.org[2]=vertices[i+2]
};

var Fbuf=function(){
	this.z=0;
	this.nrm=new Vec3();
	this.side=false;
	this.vertices=[null,null,null]
	this.edges=[null,null,null]
};
var fbufs=[];
for(i=0;i<faces.length;i+=3){
	var fbuf=new Fbuf();
	fbufs.push(fbuf);
	fbuf.vertices[0]=vbufs[faces[i+0]];
	fbuf.vertices[1]=vbufs[faces[i+1]];
	fbuf.vertices[2]=vbufs[faces[i+2]];
};
var Edge=function(){
	this.faces=[null,null]
	this.vertices=[null,null]
}
var edges=[];
var setEdge=function(a,b,c){
	var edge,i;

	for(i=edges.length;i--;){
		edge=edges[i];
		if((edge.vertices[0]==a && edge.vertices[1]==b)
			|| (edge.vertices[0]==b && edge.vertices[1]==a)){ break };
	};
	if(i>=0){
		edge.faces[1]=c;
	}else{
		edge=new Edge();
		edge.vertices[0]=a
		edge.vertices[1]=b
		edge.faces[0]=c
		edges.push(edge);
	};
	return edge;
};
for(var i=fbufs.length;i--;){
	var fbuf=fbufs[i];
	fbuf.edges[0]=setEdge(fbuf.vertices[0],fbuf.vertices[1],fbuf);
	fbuf.edges[1]=setEdge(fbuf.vertices[1],fbuf.vertices[2],fbuf);
	fbuf.edges[2]=setEdge(fbuf.vertices[2],fbuf.vertices[0],fbuf);
};
var veca=new Vec3();
var vecb=new Vec3();
var tMat=new Mat();
var mat=new Mat();
var frame = 0;

var rnd=function(){return Math.random()-0.5;};
var sin=Math.sin;
var cos=Math.cos;

var mainloop=function(e){
	var i,v,vbuf,fbuf;
	frame++;

	var a=Math.PI*frame*0.01;
	
	Mat.set(tMat,1,0,0,0,0,1,0,0,0,0,1,0,0,0,400,1);
	
	Mat.set(mat,-1,0,0,0
		,0,cos(a),sin(a),0
		,0,sin(a),-cos(a),0
		,0,0,0,1);
	Mat.dot(tMat,tMat,mat);

	Mat.set(mat,cos(a*2),0,sin(a*2),0
		,0,-1,0,0
		,sin(a*2),0,-cos(a*2),0
		,0,0,0,1)
	Mat.dot(tMat,tMat,mat);

	for(i=vbufs.length;i--;){
		vbuf=vbufs[i];
		v=vbuf.org;

		vbuf.p[0]=tMat[0]*v[0]+tMat[4]*v[1]+tMat[8]*v[2]+tMat[12]+rnd()*5;
		vbuf.p[1]=tMat[1]*v[0]+tMat[5]*v[1]+tMat[9]*v[2]+tMat[13]+rnd()*5;
		vbuf.p[2]=tMat[2]*v[0]+tMat[6]*v[1]+tMat[10]*v[2]+tMat[14]+rnd()*5;
		
		vbuf.x=(vbuf.p[0]/vbuf.p[2]+0.5)*WIDTH;
		vbuf.y=(vbuf.p[1]/vbuf.p[2]+0.5)*HEIGHT;

		Vec3.set(vbufs[i].nrm,0,0,0)
	}
	for(i=fbufs.length;i--;){
		fbuf=fbufs[i];
		var vb0=fbuf.vertices[0];
		var vb1=fbuf.vertices[1];
		var vb2=fbuf.vertices[2];

		var dx1=vb1.p[0]-vb0.p[0]
		,dy1=vb1.p[1]-vb0.p[1]
		,dz1=vb1.p[2]-vb0.p[2]
		,dx2=vb2.p[0]-vb0.p[0]
		,dy2=vb2.p[1]-vb0.p[1]
		,dz2=vb2.p[2]-vb0.p[2]
		fbuf.nrm[0]=dy1*dz2-dz1*dy2
		fbuf.nrm[1]=dz1*dx2-dx1*dz2
		fbuf.nrm[2]=dx1*dy2-dy1*dx2
		Vec3.nrm(fbuf.nrm,fbuf.nrm);
		;
		Vec3.add(vb0.nrm,vb0.nrm,fbuf.nrm);
		Vec3.add(vb1.nrm,vb1.nrm,fbuf.nrm);
		Vec3.add(vb2.nrm,vb2.nrm,fbuf.nrm);

		fbuf.side=((vb1.x-vb0.x)*(vb2.y-vb0.y)-(vb1.y-vb0.y)*(vb2.x-vb0.x)>0);
	};
	for(i=vbufs.length;i--;){
		vbuf=vbufs[i]
		Vec3.nrm(vbuf.nrm,vbuf.nrm)
		vbuf.l=-Vec3.dot(vbuf.nrm,light)*0.5+0.5;
	}

	for(i=fbufs.length;i--;){
		fbuf=fbufs[i];
		fbuf.z=fbuf.vertices[0].p[2] +fbuf.vertices[1].p[2] +fbuf.vertices[2].p[2];
	}
	margeSort(fbufs,0,fbufs.length-1);

	draw(ctx);
	
	setTimeout(mainloop,66);
};

var sortbufs=new Array(fbufs.length);
var margeSort=function(objs,left,right){
	if(left==right)return;

	var mid=(right+left)>>1;
	margeSort(objs,left,mid);
	margeSort(objs,mid+1,right);

	var i=left,j=mid+1,k;
	for(k=left;k<=right;k++){
		if(j>right || ((i<=mid) && objs[i].z<objs[j].z)){
			sortbufs[k]=objs[i++];
		}else{
			sortbufs[k]=objs[j++];
		};
	};
	for(k=left;k<=right;k++){ objs[k]=sortbufs[k] };
};

var draw = function(ctx){
	var i,j;
	var edge,vbuf,fbuf;
	var u0,u1,u2;
	var dx1,dx2,dy1,dy2,du1,du2,X,Y,U;

	ctx.globalCompositeOperation='source-over';
	ctx.fillStyle="#FFFFFF";
	ctx.fillRect(0,0,WIDTH,HEIGHT);

	for(i=fbufs.length;i--;){
		fbuf=fbufs[i];
		if(!fbuf.side)continue;

		var vb0=fbuf.vertices[0];
		var vb1=fbuf.vertices[1];
		var vb2=fbuf.vertices[2];

		ctx.save();
		ctx.beginPath();
		ctx.moveTo(vb0.x,vb0.y);
		ctx.lineTo(vb1.x,vb1.y);
		ctx.lineTo(vb2.x,vb2.y);
		ctx.closePath();
		ctx.clip();

		u0=vb0.l
		u1=vb1.l
		u2=vb2.l

		dx1=vb1.x-vb0.x;
		dx2=vb2.x-vb0.x;
		dy1=vb1.y-vb0.y;
		dy2=vb2.y-vb0.y;
		du1=u1-u0;
		du2=u2-u0;
		X = dy1*du2-du1*dy2;
		Y = du1*dx2-dx1*du2;
		U = -(dx1*dy2-dy1*dx2) /(X*X+Y*Y);

		X*=U;
		Y*=U;

		var x0=vb0.x-X*u0;
		var y0=vb0.y-Y*u0;
		
		var grad=ctx.createLinearGradient(x0,y0,x0+X,y0+Y);

		grad.addColorStop(0,'rgba(255,255,255,0)');
		grad.addColorStop(0.45,'rgba(255,255,255,0)');
		grad.addColorStop(0.50,'rgba(255,255,255,1)');
		grad.addColorStop(1,'rgba(255,255,255,1)');
		ctx.fillStyle=grad;
		ctx.globalCompositeOperation='copy';
		
		ctx.fillRect(0,0,WIDTH,HEIGHT);
		ctx.restore();

		ctx.globalCompositeOperation='source-over';
		ctx.strokeStyle="#000000";
		ctx.lineWidth=1.5;
		ctx.beginPath();
		for(j=0;j<3;j++){
			edge=fbuf.edges[j];
			if(edge.faces[1]){
				if(edge.faces[0].side == edge.faces[1].side)continue;
			};
			vb0=edge.vertices[0];
			vb1=edge.vertices[1];
			ctx.moveTo(vb0.x+rnd()*6,vb0.y+rnd()*6);
			ctx.lineTo(vb1.x+rnd()*6,vb1.y+rnd()*6);
			ctx.moveTo(vb0.x+rnd()*6,vb0.y+rnd()*6);
			ctx.lineTo(vb1.x+rnd()*6,vb1.y+rnd()*6);
		};
		ctx.closePath();
		ctx.stroke();
	};

	ctx.globalCompositeOperation='destination-over';
	ctx.beginPath();
	for(i=64;i--;){
		var x=WIDTH*2/64*i+rnd()*10;
		var y=rnd()*50+50;
		ctx.moveTo(x,y);
		ctx.lineTo(x-100+rnd()*10,y+200+rnd()*50);
	};
	ctx.closePath();
	ctx.stroke();
	ctx.fillStyle="#ffffff";
	ctx.fillRect(0,0,WIDTH,HEIGHT);
};

var canvas=  document.getElementById('c');
WIDTH=canvas.width;
HEIGHT=canvas.height;
ctx = canvas.getContext('2d');

mainloop()

</script>
