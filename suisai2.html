<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<style>
</style>
<script>
var fileselect=function(evt){
	var reader = new FileReader();

    reader.onload = (function(theFile) {
     return function(e) {
         shori(e.target.result);
        };
      })(files[0]);

	files = evt.target.files;
      reader.readAsDataURL(files[0]);
}
</script>
<body bgcolor="gray">
<input type="file" id='files' change='fileselect(event)' /><br>
<img id="org">
<img id="out">
</body>
<script type="text/javascript">
"use strict"

var det3 = 1/3;
var rgb2hsv=function(hsv,r,g,b){
	var max=Math.max(r,Math.max(g,b));
	var min = Math.min(r,Math.min(g,b));
	if(max==min) hsv[0]=0;
	else if(max==r) hsv[0]=(60*(g-b)/(max-min)+360)%360
	else if(max==g) hsv[0]=(60*(b-r)/(max-min))+120;
	else if(max==b) hsv[0]=(60*(r-g)/(max-min))+240;
	
   	if(max==0) hsv[1]=0;
	else hsv[1]=(255*((max-min)/max));
	
	hsv[2]=max;
}
var hsv2rgb=function(rgb,h,s,v){
	var f,i,p,q,t;
	i= (Math.floor(h/60.0)|0)%6;
	f=(h/60.0) - ((h/60.0)|0);
	p= (v*(1.0-(s/255.0)))|0;
	q= (v*(1.0-(s/255.0)*f))|0;
	t= (v*(1.0-(s/255.0)*(1.0-f)))|0;
	switch(i){
		case 0:rgb[0]=v;rgb[1]=t;rgb[2]=p;break;
		case 1:rgb[0]=q;rgb[1]=v;rgb[2]=p;break;
		case 2:rgb[0]=p;rgb[1]=v;rgb[2]=t;break;
		case 3:rgb[0]=p;rgb[1]=q;rgb[2]=v;break;
		case 4:rgb[0]=t;rgb[1]=p;rgb[2]=v;break;
		case 5:rgb[0]=v;rgb[1]=p;rgb[2]=q;break;
	}
}

var createPerinNoiz2=function(width,height,size){
	var arr = new Array(width*height)
	var a,b,c,d,alpha=1
	for(var i=0;i<width*height;i++)arr[i]=Math.random();
	while(size>1){
		alpha*=0.5;
		for(var i=0;i<height-size;i+=size){
			for(var j=0;j<width-size;j+=size){
				var n=i*width+j
				a=arr[n];b=arr[n+size];c=arr[n+size*width];d=arr[n+size*(width+1)];
				arr[n+(size>>1)] = arr[n+(size>>1)]*alpha + (a+b)*0.5*(1-alpha);
				arr[n+(size>>1)*width] = arr[n+(size>>1)*width]*alpha + (a+c)*0.5*(1-alpha);
				arr[n+(size>>1)*(width+1)] = arr[n+(size>>1)*(width+1)]*alpha + (a+b+c+d)*0.25*(1-alpha);
			}
		}
		size>>=1;
	}
	return arr;
}

var suisai = function(dest,src,low,high){
	var i,j
	var col
	var imax=(width*height)*3

	for(i=0;i<imax;i+=3){
		col=(src[i]+src[i+1]+src[i+2])/3
		if(col<low|| col>=high){
			dest[i+0]=255
			dest[i+1]=255
			dest[i+2]=255
			continue;
		}
		dest[i+0]=src[i+0]
		dest[i+1]=src[i+1]
		dest[i+2]=src[i+2]

	}
}
var nijimi3=function(data){
	var noizdata = createPerinNoiz2(width,height,32,4);
	for(var i=width*height;i--;){
		if((data[i*3]+data[i*3+1]+data[i*3+2]) <200*3){
			noizdata[i]=0.5
		}
	}

	var n,nn;
	var n4;
	var k;
	var x,y
	for(var l=0;l<16;l++){
		bufdata=data.slice(0);
	for(var i=1;i<height-1;i++){
		for(var j=1;j<width-1;j++){
			n=(i*width+j)
			n4=n*3;
			x=0;y=0;

			var r=0,g=0,b=0
				var count=0;
			for(k=1;k<9;k+=2){
				r+=bufdata[n4+nnd[k]]
				g+=bufdata[n4+nnd[k]+1]
				b+=bufdata[n4+nnd[k]+2]
			}
			r/=4;
			g/=4;
			b/=4;

			if(noizdata[n]<0.4 || l==0 ){
			data[n4]=Math.min(data[n4],r)
			data[n4+1]=Math.min(data[n4+1],g)
			data[n4+2]=Math.min(data[n4+2],b)
			}else if(noizdata[n]>0.7 ){
			data[n4]=Math.max(data[n4],r)
			data[n4+1]=Math.max(data[n4+1],g)
			data[n4+2]=Math.max(data[n4+2],b)
			}else{
			}

		}
	}
	}
}
var nnd,width,height

var edge=function(data){
	var data2=data.slice(0);

	var n;
	var sre=30
	var i = (width+1)*3
	var imax=(width*height-width)*3
	var hsv=Array(3)
	for(;i<imax;i+=3){
		if(data[i+3]==0)continue;
		for(var k=0;k<9;k++){
			if(k==4)continue;
			var n=i+nnd[k]
			if(Math.abs(data2[i]-data2[n])>sre
			||Math.abs(data2[i+1]-data2[n+1])>sre
			||Math.abs(data2[i+2]-data2[n+2])>sre){
				rgb2hsv(hsv,data2[i],data2[i+1],data2[i+2])
				hsv2rgb(hsv,hsv[0],hsv[1]+10,hsv[2]-10)
				data[i]=hsv[0]
				data[i+1]=hsv[1]
				data[i+2]=hsv[2]
				break;
			}
		}
	}
}

window.onload=function(){
	document.getElementById('files').addEventListener('change', fileselect, false)
	shori("test.jpg")
	
}

var debug=0
var shori=function(filename){
	var orgImg=	document.getElementById("org");
	orgImg.src=filename;
	orgImg.onload=function(e){
		width=e.target.width;
		height=e.target.height;
		var img;
		nnd=[(-1-width)*3,-width*3,(1-width)*3,-3,0,3,(-1+width)*3,width*3,(1+width)*3];


		var c=document.createElement('canvas')
		c.setAttribute('width',width)
		c.setAttribute('height',height)

		var ctx = c.getContext('2d');
		ctx.fillStyle="#fff"
		ctx.fillRect(0,0,width,height)
		
		ctx.drawImage(orgImg,0,0);
		var src=ctx.getImageData(0,0,width,height)
		var datatrue=src.data
		var data =  new Array(width*height*3)
		for(var i=height*width*3;i--;) data[i]=datatrue[i+i*det3|0]

		var arr=new Array(3)
		var imax=width*height*3;
		var num=new Array(9)
		imax=(width*height)*3;
		for(var i=0;i<imax;i+=3){
			rgb2hsv(arr,data[i],data[i+1],data[i+2])
			if(arr[1]>0)arr[1]=arr[1]&0xe0|0xf;
			arr[2]=arr[2]&0xe0|0xf;
			data[i]=arr[0];
			data[i+1]=arr[1];
			data[i+2]=arr[2];
		}
		var data2 = data.slice(0);
		imax=(width*height-width)*3;
		for(var i=(width+1)*3;i<imax;i+=3){
			for(k=0;k<9;k++){
				num[k]=data2[i+2+nnd[k]] + k/10
			}
			for(var k=0;k<9;k++){
				var cnt=0;
				for(var j=0;j<9;j++){
					if(num[k]<num[j]) cnt++;
				}
				if(cnt==4){
					data[i+0]=data2[i+nnd[k]]
					data[i+1]=data2[i+nnd[k]+1]
					data[i+2]=data2[i+nnd[k]+2]
					break;
				}
			}
		}

		var outdata=new Array(width*height*3);
		for(i=0;i<width*height*3;i++)outdata[i]=1;

		var k,kmax;
		k=0;kmax=4;
		if(debug){
			k=3;
			kmax=k+1;
		}

		var sre=256
		for(;k<kmax;k++){
			imax=width*height*3
			for(i=0;i<imax;i+=3){
				var col=(data[i+2])
				if(col<256-64*k && col>=192-64*k){
					hsv2rgb(arr,data[i],data[i+1],data[i+2])
					data2[i+0]=arr[0]
					data2[i+1]=arr[1]
					data2[i+2]=arr[2]
				}else{
					data2[i+0]=255
					data2[i+1]=255
					data2[i+2]=255
				}	
			}

			var noiz = createPerinNoiz2(width,height,32);
			for(var i=width*height;i--;){
				if((data2[i*3]+data2[i*3+1]+data2[i*3+2]) <200*3){
					//noiz[i]=0.5
				}
			}

			var n,nn;
			var n4;
			var bufdata;
			for(var l=0;l<16;l++){
				bufdata=data2.slice(0);
				for(var i=1;i<height-1;i++){
					for(var j=1;j<width-1;j++){
						n=(i*width+j)
						n4=n*3;

						var r=0,g=0,b=0
							var count=0;
						for(var m=0;m<9;m+=1){
							r+=bufdata[n4+nnd[m]]
							g+=bufdata[n4+nnd[m]+1]
							b+=bufdata[n4+nnd[m]+2]
						}
						r/=9;
						g/=9;
						b/=9;

						if(noiz[n]<0.4 || l==0 ){
						data2[n4]=Math.min(bufdata[n4],r)
						data2[n4+1]=Math.min(bufdata[n4+1],g)
						data2[n4+2]=Math.min(bufdata[n4+2],b)
						}else if(noiz[n]>0.7 ){
						data2[n4]=Math.max(bufdata[n4],r)
						data2[n4+1]=Math.max(bufdata[n4+1],g)
						data2[n4+2]=Math.max(bufdata[n4+2],b)
						}else{
						}
					}
				}
			}
			noiz = createPerinNoiz2(width,height,64,4);
			for(var i=height*width;i--;){
					var n=i*3
					rgb2hsv(arr,data2[n],data2[n+1],data2[n+2])
					arr[0]=(arr[0]+noiz[i]*4)%360
					if(arr[1]>0){
						arr[1]=Math.min(255,arr[1]*(noiz[i]+0.5))
					}	
					arr[2]=Math.min(255,arr[2]+noiz[i]*128);
					hsv2rgb(arr,arr[0],arr[1],arr[2])
				
					data2[n+0]=arr[0];
					data2[n+1]=arr[1];
					data2[n+2]=arr[2];
			}
	//		edge(data2);

			var det255=1/255;
			for(var i=height*width*3;i--;) outdata[i]*=data2[i]*det255
		}

		for(var j=height*width*3;j--;) datatrue[j+j*det3|0]=outdata[j]*255
		
		ctx.putImageData(src,0,0);
		document.getElementById("out").src = c.toDataURL("image/png");
	}

}
</script>
