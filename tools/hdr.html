<html>
<head>
<title>hdr</title>
<style>
.hoge div{
display:inline-block;
border:2px ridge;
padding:2px;
vertical-align:top;
}
canvas{
display:none;
}
</style>
</head>
<script type="text/javascript" src="../lib/inherits.js"></script>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript" src="../lib/vector.js"></script>
<script type="text/javascript">
"use strict"
var ctx,canvas;
var ImgObj=function(){
	this.img=null;
	this.data=null;
	this.span=null;
}
var srcA=new ImgObj();
var srcB=new ImgObj();
var dst=new ImgObj();


var calc=function(){
	var dataA=srcA.data;
	var dataB=srcB.data;
	var data=dst.data;
	for(var i=0;i<data.length;i+=4){
		for(var j=0;j<3;j++){
			data[j]=dataA[j]+dataB[j];
		}
	}
	ctx.putImageData(srcimg,0,0,0,0,width,height);
	img.src=canvas.toDataURL("image/png");

}
var enc=function(){
	var data = dst.data;
	var width=dst.img.width;
	var height=dst.img.height;
	for(var i=0;i<width*height;i++){
		var m = Math.max(Math.max(data[i*4],data[i*4+1]),data[i*4+2]);
		var e = Math.log2(m/256)|0;
		var d=1.0/Math.pow(2,e);
		data[i*4]*=d;
		data[i*4+1]*=d;
		data[i*4+2]*=d;
		data[i*4+3]=128+e;
	}
	ctx.putImageData(srcimg,0,0,0,0,width,height);
	img.src=canvas.toDataURL("image/png");

}

var onloadfunc=function(e){

	var objs = document.getElementsByTagName("input");
	for(var i=0;i<objs.length;i++){
		objs[i].addEventListener("change",function(evt){
			var file=evt.target.files[0];
			var img = this.parentNode.getElementsByTagName("img")[0];
			if(/\.hdr$/.test(file.name)){

				var reader=new FileReader();
				reader.onload=function(e){
					Util.loadBinary(e.target.result,function(buffer){
						var data=cbloadHdr(buffer);
						var srcimg=ctx.getImageData(0,0,canvas.width,canvas.height);
						var width=canvas.width;
						var height=canvas.height;

						for(var i=0;i<width*height;i++){
							var e = Math.pow(2.0,data[i*4+3]-128);
							data[i*4]*=e;
							data[i*4+1]*=e;
							data[i*4+2]*=e;
							data[i*4+3]=255;

						}
						for(var i=0;i<width*height*4;i++){
							srcimg.data[i]=data[i];
						}

						ctx.putImageData(srcimg,0,0,0,0,width,height);
						img.src=canvas.toDataURL("image/png");

						var o=[srcA,srcB,dst];
						for(var j=0;j<o.length;o++){
							if(img == o[j].img){
								o[j].data=data;
								break;
							}
						}
					});

				}
				reader.readAsDataURL(file);
			}
		});

	}

	var objs = document.getElementsByTagName("img");
	for(var i=0;i<objs.length;i++){
		objs[i].addEventListener("mousemove",function(e){
			var img = this.parentNode.getElementsByTagName("img")[0];
			var o=[srcA,srcB,dst];
			var data=null;
			for(var j=0;j<o.length;o++){
				if(img == o[j].img){
					data=o[j].data;
					break;
				}
			}
			if(!data){return;}

			var x=e.offsetX;
			var y=e.offsetY;
			var width=e.target.width;
			var height=e.target.height;
			var output = this.parentNode.getElementsByTagName("span")[0];

			if(x<0 || y<0 || x>=width || y>=height){return;}

			var idx=(y*canvas.width+x)*4;
			var r= data[idx];
			var g= data[idx+1];
			var b= data[idx+2];
			var e= data[idx+3];
			var pow=Math.pow(2,e-128)/256;

			var str="position X:[x],Y:[y] \n value R:[r], G:[g], B:[b] ";
			str=str.replace(/\[x\]/,x);
			str=str.replace(/\[y\]/,y);
			str=str.replace(/\[r\]/,(r/256.0).toFixed(2));
			str=str.replace(/\[g\]/,(g/256.0).toFixed(2));
			str=str.replace(/\[b\]/,(b/256.0).toFixed(2));
			Util.setText(output,str);

		},false);
	}
 
	canvas =  document.getElementById('c')
	ctx =  canvas.getContext('2d')
	var obj = document.getElementById("dst");
	dst.img=obj.getElementsByTagName("img")[0];
	dst.span=obj.getElementsByTagName("span")[0];

	obj = document.getElementById("srcA");
	srcA.img=obj.getElementsByTagName("img")[0];
	srcA.span=obj.getElementsByTagName("span")[0];

	obj = document.getElementById("srcB");
	srcB.img=obj.getElementsByTagName("img")[0];
	srcB.span=obj.getElementsByTagName("span")[0];

}

var idx;
var dv;
var readTextBuf=function(){
	var str="";
	var a;
	while((a=dv.getUint8(idx++)) != 10){
		str+=String.fromCharCode(a);
	}
	return str;
}
var cbloadHdr = function(arrayBuffer){
	idx=0;
	dv = new DataView(arrayBuffer);

	//空行までスキップ
	while(idx<dv.byteLength){
		var c=dv.getUint8(idx++);
		if(c==10 || c==13){
			c=dv.getUint8(idx++);
			if(c==10 || c==13){
				break;
			}
		}
	}
	//画像サイズ
	var str = "";

	while((c=dv.getUint8(idx++)) != 10){
		str+=String.fromCharCode(c);
	}
	var strs =str.split(" ");
	var height =parseInt(strs[1]);
	var width=parseInt(strs[3]);

	canvas.width=width;
	canvas.height=height;
	var data=new Array(width*height*4);
			

	var x,y=0;
	for(y=0;y<height;y++){
		idx+=4;
		for(var rgbe=0;rgbe<4;rgbe++){
			x=0;
			var offset=y*4*width + rgbe;
			while(x<width){
				var c=dv.getUint8(idx++);
				if(c>128){
					var size=c-128;
					c=dv.getUint8(idx++);
					for(var i=0;i<size;i++){
						data[x*4+offset]=c;
						x++;
					}
				}else{
					var size=c;
					for(var i=0;i<size;i++){
						c=dv.getUint8(idx++);
						data[x*4+offset]=c;
						x++;
					}
				}
			}
		}
	}
	return data;
	

}


</script>

<body onLoad="onloadfunc(event)">

<div class="hoge">
	<div id="srcA">
	<input type="file">
		srcA<br>
		<img />
		<br><span></span>
	</div>

	<div id="srcB">
		<input type="file">
		srcB<br>
		<img />
		<span></span>
	</div>
	<div id="dst">
	dst<br>
	<img />
	<canvas id="c" ></canvas><br />
	enc<br />
	<img>
	<span></span>
</div>
</div>
</body>
</html>

