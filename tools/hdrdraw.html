<html>
<head>
<title>hdrdraw</title>
<style>
.hoge{
border:solid;
overflow:scroll;
width:600px;
height:600px;
}

.layers{
border:solid;
overflow:scroll;
width:200px;
height:600px;
}
.layer{
border:solid;
width:100%;
height:64px;
}

</style>
</head>
<script type="text/javascript" src="../lib/inherits.js"></script>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript" src="../lib/vector.js"></script>
<script type="text/javascript" src="../lib/openexr.js"></script>
<script type="text/javascript">
"use strict"
var ctx,canvas;
var ctx_data=new Float32Array(512*512*4);
var img;
var ctx2,canvas2;
var layers=[];
var layers_container;
var layer_template;


var refresh = function(layer){
	var img = layer.img;
	var img_data=img.data;
	for(var di=0;di<canvas.width*canvas.height;di++){
		var idx=di<<2;
		for(var ii=0;ii<4;ii++){
			ctx_data[idx+ii]=img_data[idx+ii];
		}
	}
//	var imgdata=ctx2.createImageData(64,64);
//	var imgdata_data = imgdata.data;
//	var yr= img.height/imgdata.height;
//	var xr= img.width/imgdata.width;
//	for(var yi=0;yi<imgdata.height;yi++){
//		for(var xi=0;xi<imgdata.width;xi++){
//			var idx=(yi*imgdata.width + xi)<<2;
//			var idx2=((yr*yi|0)*img.width+ (xr*xi|0))<<2;
//			for(var ii=0;ii<4;ii++){
//				imgdata_data[idx+ii]=img_data[idx2+ii]*255.0;
//			}
//		}
//	}
//	ctx2.putImageData(imgdata,0,0);
	ctx2.drawImage(canvas,0,0,canvas.width,canvas.height,0,0,canvas2.width,canvas2.height);
	var layer_img=layer.div.getElementsByTagName("img")[0];
	layer_img.src=canvas2.toDataURL("image/png");
}

var Img = (function(){
	var Img = function(){
		this.data=null;
		this.width=0;
		this.height=0;
	};
	var ret = Img;

	return ret;
});
var Layer=(function(){
	var Layer = function(){
		ret.img;
		ret.power=1.0;
		ret.opacity=1.0;
		ret.div=null;
	};
	var ret = Layer;
	return ret;
})();

var loadImg=function(url,func){
	var image = new Image();
	image.src=url;
	var img=new Img();
	image.onload=function(e){
		canvas.width=image.width;
		canvas.height=image.height;
		ctx_data=new Float32Array(canvas.width*canvas.height*4);
		ctx.drawImage(image,0,0);
		img.data=new Float32Array(canvas.width*canvas.height*4);
		var data=ctx.getImageData(0,0,image.width,image.height).data;
		for(var di=0;di<canvas.width*canvas.height*4;di++){
			img.data[di]=data[di]/255.0;
		}
		img.width=image.width;
		img.height=image.height;

		if(func){
			func(img);
		}
	}
	return img;
}

var onloadfunc=function(e){
	canvas =  document.getElementById('c')
	ctx =  canvas.getContext('2d')
	canvas2 =  document.createElement('canvas');
	canvas2.width=64;
	canvas2.height=64;
	ctx2 =  canvas2.getContext('2d')

	var file=document.getElementById("f");
	file.addEventListener("change",function(evt){
		var reader=new FileReader();
		reader.onload=function(e){

			var layer = new Layer();
			var layer_div = layer_template.children[0].cloneNode(true);
			layer.div=layer_div;
			
			layers_container.appendChild(layer_div);

			img=loadImg(e.target.result,function(d){
				refresh(layer);

			});
			layer.img=img;
		}
		var file=evt.target.files[0];
		reader.readAsDataURL(file);
		
	});


	canvas.addEventListener("mousemove",function(e){
		var data = ctx_data;


		var x=e.offsetX;
		var y=e.offsetY;
		var width=e.target.width;
		var height=e.target.height;
		var output = document.getElementsByTagName("span")[0];

		if(x<0 || y<0 || x>=width || y>=height){return;}

		var idx=(y*canvas.width+x)*4;
		var r= data[idx];
		var g= data[idx+1];
		var b= data[idx+2];
		var a= data[idx+3];

		var str="position X:[x],Y:[y] \n value R:[r], G:[g], B:[b], A:[a] ";
		str=str.replace(/\[x\]/,x);
		str=str.replace(/\[y\]/,y);
		str=str.replace(/\[r\]/,(r).toFixed(4));
		str=str.replace(/\[g\]/,(g).toFixed(4));
		str=str.replace(/\[b\]/,(b).toFixed(4));
		str=str.replace(/\[a\]/,(a).toFixed(4));
		Util.setText(output,str);

	},false);
	

	layer_template= document.getElementById("layer_template");
	layers_container = document.getElementById("layers_container");

}



</script>

<body onLoad="onloadfunc(event)">

<input type="file" id="f"><br>
<div style="float:left;">
	<div class="hoge">
		<canvas width="512" height="512" id="c" ></canvas><br />
	</div>
	<br><span></span>
</div>


<div style="display:none;" id="layer_template">
	<div class="layer">
	<img width="64" height="64">
	</div>
</div>
<div class="layers" id="layers_container">
</div>
</body>
</html>

