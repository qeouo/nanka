<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>closest</title>
<script type="text/javascript" src="./lib/vector.js"></script>
<script type="text/javascript">
"use strict"
var ctx
var objs= new Array(32);
var WIDTH=300
,HEIGHT=300;
var 
	MSG_CREATE=0
	,MSG_MOVE = 1
	,MSG_DRAW= 2
;

	
var mouse = new Vec2();
var oldmouse = new Vec2();
oldmouse[0]=0;
oldmouse[1]=0;
mouse[0]=0;
mouse[1]=0;
var btn;
window.onmousedown = function (e) {
    btn = true;
}
window.onmouseup = function (e) {
    btn = false;
}
window.onmousemove = function (e) {
    e = e || window.event;
    mouse[0] = e.pageX- maincanvas.offsetLeft;
    mouse[1] = e.pageY- maincanvas.offsetTop;
}


var objs=new Array();
var Obj= function(){
	this.p=new Vec3();
	this.func=null;
}
var point=function(obj,msg,param){
	switch(msg){
	case MSG_MOVE:
		break;
	case MSG_DRAW:
		drawPoint(obj.p);
		break;
	}

}
var drawPoint=function(p){
	calcPoint(p);
	ctx.fillRect(calcedPos[0],calcedPos[1],10,10);
}
var cp=new Vec3();
cp[0]=0;
cp[1]=0;
cp[2]=-100;
var ca=new Vec3();
ca[0]=0;
ca[1]=0;
ca[2]=0;
var viewMatrix=new Mat43();
var mat43=new Mat43();
var calcedPos=new Vec3(); 
var calcPoint= function(p){

	Mat43.dotMat43Vec3(calcedPos,viewMatrix,p);
	var w=1/(calcedPos[2]);
	calcedPos[0]=(calcedPos[0])*w+(WIDTH>>1)
	calcedPos[1]=(calcedPos[1])*w+(HEIGHT>>1)
}

var onloadfunc=function(e){
	ctx =  document.getElementById('maincanvas').getContext('2d')
	setTimeout(mainloop,33)
	for(var i=0;i<2;i++){
		var obj=new Obj();
		objs.push(obj);
		obj.p[0]=1+10*i;
		obj.p[1]=0;
		obj.p[2]=0;
		obj.func=point;
	}

}
var mainloop=function(e){
	setTimeout(mainloop,33);
	ctx.clearRect(0,0,WIDTH,HEIGHT);

	if(btn){
		ca[1]+=(mouse[0]-oldmouse[0])*0.01;
		ca[0]+=(mouse[1]-oldmouse[1])*0.01;
	}
	if(ca[0]<-(Math.PI/2))ca[0]=-Math.PI/2;
	if(ca[0]>(Math.PI/2))ca[0]=Math.PI/2;
	cp[0]=0;
	cp[1]=0;
	cp[2]=-1;
	cp[0]=Math.sin(ca[1])
	cp[2]=-Math.cos(ca[1])
	
	Vec3.mult(cp,cp,100);

	Mat43.setInit(viewMatrix);
	viewMatrix[12]=-cp[0];
	viewMatrix[13]=-cp[1];
	viewMatrix[14]=-cp[2];
	Mat43.getRotMat(mat43,-ca[2],0,0,1);
	Mat43.dot(viewMatrix,mat43,viewMatrix);
	Mat43.getRotMat(mat43,-ca[0],1,0,0);
	Mat43.dot(viewMatrix,mat43,viewMatrix);
	Mat43.getRotMat(mat43,-ca[1],0,1,0);
	Mat43.dot(viewMatrix,mat43,viewMatrix);

	for(var i=0,imax=objs.length;i<imax;i++){
		var obj=objs[i];
		obj.func(obj,MSG_DRAW,0);
	}
	
	oldmouse[0]=mouse[0]
	oldmouse[1]=mouse[1]
}

</script>
</head>
<body onLoad="onloadfunc(event)">
<canvas id="maincanvas" width="300" height="300" style="border:solid 1px black;vertical-align:top;">
</canvas>
</body>
</html>

