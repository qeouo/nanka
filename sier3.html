<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<style>
canvas{
	border:solid 1px black;
	width:320px;height:180px;"

}
</style>
<body >
<div id="fps"></div>
<canvas id="c" width="160" height="90">
</canvas>
</body>
<script type="text/javascript">
"use strict"

var Vec3=(function(){
	var Vec3=function(){this[0]=0;this[1]=0;this[2]=0;};
    Vec3.set=function(a,x,y,z){a[0]=x;a[1]=y;a[2]=z};
    Vec3.add=function(a,b,c){a[0]=b[0]+c[0];a[1]=b[1]+c[1];a[2]=b[2]+c[2]};
	Vec3.nrm=function(a,b){
		var s=1/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);
		a[0]*=s;a[1]*=s;a[2]*=s;
	};
    Vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2];};
	return Vec3;
})();
var Mat=(function(){
	var v = new Array(16);
	var i;
	var Mat = function(){
		this[0]=1;this[1]=0;this[2]=0;this[3]=0;
		this[4]=0;this[5]=1;this[6]=0;this[7]=0;
		this[8]=0;this[9]=0;this[10]=1;this[11]=0;
		this[12]=0;this[13]=0;this[14]=0;this[15]=1;
	};
	Mat.set = function(m,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14,a15){
		m[0]=a0;m[1]=a1;m[2]=a2;m[3]=a3;
		m[4]=a4;m[5]=a5;m[6]=a6;m[7]=a7;
		m[8]=a8;m[9]=a9;m[10]=a10;m[11]=a11;
		m[12]=a12;m[13]=a13;m[14]=a14;m[15]=a15;
	};
	Mat.dot=function(a,b,c){
		for(i=16;i--;){
			var j=i&3;
			var k=i&12;
			v[i]=b[j]*c[k] +b[4+j]*c[k+1] +b[8+j]*c[k+2] +b[12+j]*c[k+3];
		}
		for(i=16;i--;){a[i]=v[i];}
	};
	return Mat;
})();


var canvas= document.getElementById('c');
var ctx = canvas.getContext('2d');
var WIDTH = canvas.width;
var WIDTH05 = WIDTH*0.5;
var HEIGHT = canvas.height;
var HEIGHT05 = HEIGHT*0.5
var IWIDTH = 1 / WIDTH;
var STEPMAX = 32;
var FPS = 15;
var MPF = 1000 / FPS | 0;

var frame=0;
var time = 0;
var R, G, B,DEPTH;
var cameraX = 0, cameraY = 0, cameraZ = 0;
var m0, m1, m2, m3, m4, m5, m6, m7, m8, m9;
var mm0, mm1, mm2, mm3, mm4, mm5, mm6, mm7, mm8, mm9,mm10,mm11,mm12,mm13,mm14,mm15;

var divfps = document.getElementById('fps');
var oldTime = 0
var totalFrame = 0;
var truefps=0;

var imagedata = ctx.createImageData(WIDTH, HEIGHT);
var data = imagedata.data;
for (var i = WIDTH * HEIGHT * 4 - 1; i >= 0; i -= 4) { data[i] = 255; }

var sin,cos;
var a = function (x, y, z) {
	var d,d2,d3;
	var xx,yy,zz;
	xx=(x>=0)?x:-x;
	yy=(y>=0)?y:-y;
	zz=(z>=0)?z:-z;
	xx-=1
	yy-=1
	zz-=1
	d=(xx<yy)?yy:xx;
	if(d<zz)d=zz;
	d=0
	var i
	var s=0.5;

	s*=3
	var xxx=x*s
	var yyy=y*s
	var zzz=z*s
	var addx=(x<0)?1:0;
	var addy=(y<0)?1:0;
	var addz=(z<0)?1:0;
	var sd=1/s;
	DEPTH=0
	for(i=0;i<4;i++){

		xx=xxx-(xxx^0)-0.5+addx;
		yy=yyy-(yyy^0)-0.5+addy;
		zz=zzz-(zzz^0)-0.5+addz;
		xxx*=3//s2
		yyy*=3//s2
		zzz*=3//s2

		s*=3//s2;
		sd=sd*0.33333333333
		if(xx<0)xx*=-1
		if(yy<0)yy*=-1
		if(zz<0)zz*=-1
		xx=3*(0.6666666-xx);
		yy=3*(0.6666666-yy);
		zz=3*(0.6666666-zz);
		
		d2=(xx>yy)?xx:yy;
		d3=(xx>zz)?xx:zz;
		if(d3<d2)d2=d3;

		d3=(yy>zz)?yy:zz;
		if(d3<d2)d2=d3;

		d2=-(d2-1)*sd;
		if(d<d2){
			d=d2;
			DEPTH=i+1

		}
		
	}
	return d
}
var df=function(x,y,z){
	var d
	var xx=x,yy=y,zz=z
	

	xx=x*mm0+y*mm4+z*mm8
	yy=x*mm1+y*mm5+z*mm9
	zz=x*mm2+y*mm6+z*mm10
	d=a(xx,yy,zz)
	//xx=x*mm2[0]+y*mm2[4]+z*mm2[8]
	//yy=x*mm2[1]+y*mm2[5]+z*mm2[9]
	//zz=x*mm2[2]+y*mm2[6]+z*mm2[10]
	var d2=a(x,y,z)
	d=(d<d2)?d2:d;
	return d
}

var ray = function (x, y, t) {
	var i, d, rx, ry, rz, px, py, pz,totald=0;

	x = (x - WIDTH05) *  IWIDTH;
	y = -((y - HEIGHT05) * IWIDTH);
	d = 1 + 2 * (x * x + y * y)
	x *= d
	y *= d

	rx = m0 * x + m3 * y + m6;
	ry = m1 * x + m4 * y + m7;
	rz = m2 * x + m5 * y + m8;
	d = 1 / Math.sqrt(rx * rx + ry * ry + rz * rz);
	rx *= d;
	ry *= d;
	rz *= d;

	px = cameraX;
	py = cameraY;
	pz = cameraZ;

	for (i = 0;i< STEPMAX; i++) {
		d = df(px, py, pz, t);
		if (d < 0.001) {
			break;
		}
		totald += d;
		if (totald > 10) {
			totald=10
			i = STEPMAX
			break;
		}
		px += rx * d;
		py += ry * d;
		pz += rz * d;
	}
	if(1){
		//d = 1 -(totald-1)*0.1- (i / STEPMAX)*0.9-DEPTH*0.00;
		d =  (i / STEPMAX)
		R = d
		G = d
		B = d
	}else{
		R = 0
		G = 0
		B = 0
	}

}

var dd=3
var mm=new Mat()
var mma2=new Mat()
var mma3=new Mat()
var mainloop = function (e) {
	var startTime = new Date();
	var p, i, j, d;
	time = frame / FPS;

	sin=Math.sin(time*0.01)
	cos=Math.cos(time*0.01)
	
	Mat.set(mm,cos,sin,0,0,-sin,cos,0,0,0,0,1,0,0,0,0,1)
	sin=Math.sin(Math.PI/4)
	cos=Math.cos(Math.PI/4)
	Mat.set(mma2,1,0,0,0,0,cos,sin,0,0,-sin,cos,0,0,0,0,1)
	Mat.dot(mm,mm,mma2)
	mm0=mm[0]
	mm1=mm[1]
	mm2=mm[2]
	mm3=mm[3]
	mm4=mm[4]
	mm5=mm[5]
	mm6=mm[6]
	mm7=mm[7]
	mm8=mm[8]
	mm9=mm[9]
	mm10=mm[10]
	mm11=mm[11]
	mm12=mm[12]
	mm13=mm[13]
	mm14=mm[14]
	mm15=mm[15]

	m6=0;m7=0;m8=1;
	m3=0;m4=1;m5=0;

//	cameraZ += 0.2;
//	cameraY = Math.sin(time * 0.3) * 2;
//
	m6 = Math.sin(time * 0.2) ;
	m7 = Math.sin(time * 0.1) ;
	m8 = Math.cos(time * 0.2) ;
	d = 1 / Math.sqrt(m6 * m6 + m7 * m7 + m8 * m8);
	m6 *= d; m7 *= d; m8 *= d;
//	m7 = Math.cos(time * 0.3)*0.7;
//	m8 = Math.sqrt(1 - (m6 * m6 + m7 * m7));
//	m3 = Math.cos(time * 0.1);
//	m4 = Math.sin(time * 0.1);
//	m5 = 0;
	m0 = m4 * m8 - m5 * m7;
	m1 = m5 * m6 - m3 * m8;
	m2 = m3 * m7 - m4 * m6;
	d = 1 / Math.sqrt(m0 * m0 + m1 * m1 + m2 * m2);
	m0 *= d; m1 *= d; m2 *= d;
	m3 = m7 * m2 - m8 * m1;
	m4 = m8 * m0 - m6 * m2;
	m5 = m6 * m1 - m7 * m0;

	//dd=5
	dd-=0.001
//	cameraX=-m6*dd
//	cameraY=-m7*dd
//	cameraZ=-m8*dd
	cameraX=-0.2
	cameraY=-0.2
	cameraZ=-dd

	p = 0;
	var p2=WIDTH
	var flg=0//frame&1
	for (j = 0; j < HEIGHT; j++) {
		p=(j+flg)*WIDTH*4
		p2=(j+1-flg)*WIDTH*4
		for (i = 0; i < WIDTH; i++) {
			ray(i, j)
			data[p + 0] = R * 255;
			data[p + 1] = G * 255;
			data[p + 2] = B * 255;

			//data[p2 + 0] =(data[p2+0]+ R * 255)>>1;
			//data[p2 + 1] =(data[p2+1]+ G * 255)>>1;
			//data[p2 + 2] =(data[p2+2]+ B * 255)>>1;
			p += 4
			//p2+=4
		}
		//j++;
	}
	ctx.putImageData(imagedata, 0, 0);

	var endTime = new Date();
	totalFrame++;
	frame++;
	if(endTime - oldTime >= 1000){
		truefps = Math.round(totalFrame / (endTime-oldTime) * 100000) / 100;
		totalFrame = 0;
		oldTime = endTime;
	}

	var dt = endTime - startTime;
	var wait = MPF - dt;
	if (wait < 0){
		wait = 0;
		divfps.style.color = "red";
	}else{
		divfps.style.color = "black";
	}
	divfps.innerHTML = "processing time : " + dt + "msec/frame" + " (" + truefps + "fps)";

	setTimeout(mainloop, wait);
}

mainloop();
</script>
