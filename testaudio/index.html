<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />

<script type="text/javascript" src="../lib/webaudio.js"></script>
<style type="text/css">
html,body { height:100%;margin:0;font-size:small; }
.js-slider{ width:50px;}
div.cr{background-color:gray; float:left;margin-right:2px;padding:0px;line-height:0px;}
input{margin:2px;}
</style>
<script type="text/javascript">
	var Testact = (function(){
		var NUM = 8;
		var tempo = 2/8;
		var ret = function(){};
		var seek=0;
		window.AudioContext = window.AudioContext || window.webkitAudioContext;
		var context = new AudioContext();
		var offset = context.currentTime;
		var nodes=new Array();
		var gain = context.createGain();
		gain.gain.value=0.05;
		var analyser = context.createAnalyser();
		gain.connect(analyser);
		analyser.fftSize = 512;
		analyser.smoothingTimeConstant=0.0;
		analyser.connect(context.destination);
		var bufferLength = analyser.frequencyBinCount;
		var dataArray = new Uint8Array(bufferLength);
		var playSound = function(tim,freq) {
			// 再生
			var oscillator= context.createOscillator();
			oscillator.frequency.value = freq;
			oscillator.type = 'square';
			oscillator.connect(gain);
			oscillator.start(tim);
			oscillator.stop(tim+tempo);
			//nodes.push(oscillator);
		};
//context.currentTime
		var next = context.currentTime+tempo;
		var ahead = 1;//0.025;
		var c,ctx;
		var loop=function(){
			
			seek= (context.currentTime - offset)%2;
			var current = context.currentTime - seek;
			for(var i=0;i<NUM;i++){
				var craster = document.getElementById("craster"+i);
				if((seek/tempo>>0) == i){
					craster.style.backgroundColor="orange";
				}else{
					craster.style.backgroundColor="gray";
				}
			}
			var ptn=[-14,3,7,10,13,15,19,22,25];
			for(var i =0;i<ptn.length;i++){
				ptn[i] = 220.0*Math.pow(2,ptn[i]/12);
			}
			while(context.currentTime > next - ahead){
				var nexti = ((next - offset)%2 /tempo)|0;
				craster = document.getElementById("craster"+nexti);
				var arr = new Array(8);
				var idx = 0;
				for(var j = 0;j<craster.childNodes.length;j++){
					if(craster.childNodes[j].type=="checkbox"){
						arr[idx] = craster.childNodes[j].checked;
						idx++;
					}
				}
				for(var j=0;j<8;j++){
					if(arr[j]){
						freq = ptn[7-j];
						playSound(next,freq);
					}
				}
				next+=tempo;
			}
			ctx.clearRect(0,0,256,128);
			analyser.getByteFrequencyData(dataArray);
			ctx.fillStyle="orange";
			var SIZE=dataArray.length/4;
			for(var i=0;i<SIZE;i++){
				ctx.fillRect(i/SIZE*256
					,128 - dataArray[i]/256*128
					,1/SIZE*256
					,dataArray[i]/256*128
					);
			}

			analyser.getByteTimeDomainData(dataArray);
			
			ctx.beginPath();
			ctx.moveTo(0,64);
			for(var i=0;i<256;i++){
				ctx.lineTo(i,(dataArray[i*dataArray.length/256|0]-128.0)*2+64);
			}
			ctx.stroke();
			ctx.closePath();
			setTimeout(loop,33);
		}
		ret.start = function(){
			c = document.getElementById("c");
			ctx = c.getContext("2d");
			var aa = document.getElementById("aa");
			var craster = document.getElementById("craster");
			for(var i=1;i<NUM;i++){
				var clone = craster.cloneNode(true);
				clone.id= craster.id +i
				aa.appendChild(clone);
			}
			craster.id= craster.id+"0";
			var elements = document.getElementsByTagName("input");
			for(var i = elements.length-1;i>=0;i--){
				if(elements[i].type=="checkbox"){
					elements[i].checked = Math.random()*1.3|0;
				}
			}
			setTimeout(loop,33);
		};
		return ret;
	})();
	var onl=function(){
		Testact.start();
	}

</script>

</head>
<body onload="onl();" style="height:100%;opacity:1.0;">
<span id="cons" ></span><br />
<div id="aa">
<div id="craster" class="cr" >
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
<input type="checkbox" /><br />
</div>
</div>
<div style="clear:both;">
<input type="button" value="start" id="start"/><br />
<canvas width=256 height=128 id="c"> </canvas>
</div>
</body>
</html>

