<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<style>
canvas{
	border:solid 1px black;
	width:320px;height:180px;"

}
</style>
<body >
<div id="fps"></div>
<canvas id="c" width="160" height="90">
</canvas>
</body>
<script type="text/javascript">
"use strict"

var canvas= document.getElementById('c');
var ctx = canvas.getContext('2d');
var WIDTH = canvas.width;
var WIDTH05 = WIDTH*0.5;
var HEIGHT = canvas.height;
var HEIGHT05 = HEIGHT*0.5
var IWIDTH = 1 / WIDTH;
var STEPMAX = 32;
var FPS = 15;
var MPF = 1000 / FPS | 0;

var frame=0;
var time = 0;
var R, G, B,DEPTH;
var cameraX = 0, cameraY = 0, cameraZ = 0;
var m0, m1, m2, m3, m4, m5, m6, m7, m8, m9;

var divfps = document.getElementById('fps');
var oldTime = 0
var totalFrame = 0;
var truefps=0;

var imagedata = ctx.createImageData(WIDTH, HEIGHT);
var data = imagedata.data;
for (var i = WIDTH * HEIGHT * 4 - 1; i >= 0; i -= 4) { data[i] = 255; }

var ransu = []
for (i = 256; i--;) { ransu.push(Math.random()); }
var rnd = function (a, b, c) {
	return ransu[a * 123.456789 + b * 34.5678901 + c * 5.67890123  & 255]; //tekitou
}

var mod=function(a,b){
	if(a<0){
		a=a%b+b
	}else{
		a=a%b
	}
	return a
}
var sdBox=function(x,y,z,xx,yy,zz){
	x=(x>=0)?x:-x;
	y=(y>=0)?y:-y;
	z=(z>=0)?z:-z;
	x-=xx
	y-=yy
	z-=zz
	var m=Math.max(x,Math.max(y,z))
	d=Math.min(m,0)+Math.abs(Math.max(m,0));
}
var sdCross=function(x,y,z){
	var xx,yy,zz
	var m
	var d=10000,d2
	x=(x>=0)?x:-x;
	y=(y>=0)?y:-y;
	z=(z>=0)?z:-z;
	x-=1
	y-=1
	z-=1
	m=Math.max(x,y)
	d=Math.min(m,0)+Math.abs(Math.max(m,0));
	
	m=Math.max(x,z)
	d2=Math.min(m,0)+Math.abs(Math.max(m,0));
	d=Math.min(d,d2)

	m=Math.max(y,z)
	d2=Math.min(m,0)+Math.abs(Math.max(m,0));
	d=Math.min(d,d2)
		return d;
}
var df = function (x, y, z) {
	var d,d2,d3;
	var xx,yy,zz;
	xx=(x>=0)?x:-x;
	yy=(y>=0)?y:-y;
	zz=(z>=0)?z:-z;
	xx-=1
	yy-=1
	zz-=1
	//var m=Math.max(xx,Math.max(yy,zz))
	d=(xx<yy)?yy:xx;
	if(d<zz)d=zz;
	var i
	var s=1;
	var s2=3//Math.abs(40-frame%80)*0.4+2;
	var s3=3//Math.abs(10-frame%20)*0.1+2;

	DEPTH=0
	for(i=0;i<3;i++){

		xx=x*s%2-1;
		if(x<0)xx+=2;
		yy=y*s%2-1;
		if(y<0)yy+=2;
		zz=z*s%2-1;
		if(z<0)zz+=2;

		s*=s2;
		if(xx<0)xx*=-1
		if(yy<0)yy*=-1
		if(zz<0)zz*=-1
		xx=s3*(1-xx);
		yy=s3*(1-yy);
		zz=s3*(1-zz);
		
		d2=(xx>yy)?xx:yy;
		d3=(xx>zz)?xx:zz;
		if(d3<d2)d2=d3;

		d3=(yy>zz)?yy:zz;
		if(d3<d2)d2=d3;

		d2=-(d2-1)/s;
		if(d<d2){
			d=d2;
			DEPTH=i+1

		}
		
	}
	//return Math.max(d2,d);
	return d
}

var ray = function (x, y, t) {
	var i, d, rx, ry, rz, px, py, pz,totald=0;

	x = (x - WIDTH05) *  IWIDTH;
	y = -((y - HEIGHT05) * IWIDTH);
	d = 1 + 2 * (x * x + y * y)
	x *= d
	y *= d

	rx = m0 * x + m3 * y + m6;
	ry = m1 * x + m4 * y + m7;
	rz = m2 * x + m5 * y + m8;
	d = 1 / Math.sqrt(rx * rx + ry * ry + rz * rz);
	rx *= d;
	ry *= d;
	rz *= d;

	px = cameraX;
	py = cameraY;
	pz = cameraZ;

	for (i = 0;i< STEPMAX; i++) {
		d = df(px, py, pz, t);
		if (d < 0.001) {
			break;
		}
		totald += d;
		if (d > 10) {
			i = STEPMAX
			break;
		}
		px += rx * d;
		py += ry * d;
		pz += rz * d;
	}
	if(i<STEPMAX){
		d = 1 -(totald-1)*0.2- (i / STEPMAX)*0.5-DEPTH*0.0;
		R = d
		G = d
		B = d
	}else{
		R = 0
		G = 0
		B = 0
	}

}

var mainloop = function (e) {
	var startTime = new Date();
	var p, i, j, d;
	time = frame / FPS;

	m6=0;m7=0;m8=1;
	m3=0;m4=1;m5=0;

//	cameraZ += 0.2;
//	cameraY = Math.sin(time * 0.3) * 2;
//
	m6 = Math.sin(time * 0.2) ;
	m7 = Math.sin(time * 0.1) ;
	m8 = Math.cos(time * 0.2) ;
	d = 1 / Math.sqrt(m6 * m6 + m7 * m7 + m8 * m8);
	m6 *= d; m7 *= d; m8 *= d;
//	m7 = Math.cos(time * 0.3)*0.7;
//	m8 = Math.sqrt(1 - (m6 * m6 + m7 * m7));
//	m3 = Math.cos(time * 0.1);
//	m4 = Math.sin(time * 0.1);
//	m5 = 0;
	m0 = m4 * m8 - m5 * m7;
	m1 = m5 * m6 - m3 * m8;
	m2 = m3 * m7 - m4 * m6;
	d = 1 / Math.sqrt(m0 * m0 + m1 * m1 + m2 * m2);
	m0 *= d; m1 *= d; m2 *= d;
	m3 = m7 * m2 - m8 * m1;
	m4 = m8 * m0 - m6 * m2;
	m5 = m6 * m1 - m7 * m0;

	d=3
	cameraX=-m6*d
	cameraY=-m7*d
	cameraZ+=0.01
	cameraZ=-m8*d

	p = 0;
	var p2=WIDTH
	var flg=0//frame&1
	for (j = 0; j < HEIGHT; j++) {
		p=(j+flg)*WIDTH*4
		p2=(j+1-flg)*WIDTH*4
		for (i = 0; i < WIDTH; i++) {
			ray(i, j)
			data[p + 0] = R * 255;
			data[p + 1] = G * 255;
			data[p + 2] = B * 255;

			data[p2 + 0] =(data[p2+0]+ R * 255)>>1;
			data[p2 + 1] =(data[p2+1]+ G * 255)>>1;
			data[p2 + 2] =(data[p2+2]+ B * 255)>>1;
			p += 4
			p2+=4
		}
		//j++;
	}
	ctx.putImageData(imagedata, 0, 0);

	var endTime = new Date();
	totalFrame++;
	frame++;
	if(endTime - oldTime >= 1000){
		truefps = Math.round(totalFrame / (endTime-oldTime) * 100000) / 100;
		totalFrame = 0;
		oldTime = endTime;
	}

	var dt = endTime - startTime;
	var wait = MPF - dt;
	if (wait < 0){
		wait = 0;
		divfps.style.color = "red";
	}else{
		divfps.style.color = "black";
	}
	divfps.innerHTML = "processing time : " + dt + "msec/frame" + " (" + truefps + "fps)";

	setTimeout(mainloop, wait);
}

mainloop();
</script>
