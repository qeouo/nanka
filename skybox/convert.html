<html>
<head>
<title>skybox convert</title>
</head>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript" src="../lib/vector.js"></script>
<script type="text/javascript">
"use strict"
var ctx,canvas;
var onloadfunc=function(e){
	canvas =  document.getElementById('maincanvas')
	ctx =  canvas.getContext('2d')
	Util.init(canvas,document.getElementById('main'));

	var obj1=document.getElementById("selfile");
	obj1.addEventListener("change",function(evt){
		var file=evt.target.files;
		var reader=new FileReader();
		reader.readAsDataURL(file[0]);
		reader.onload=function(){
			var dataUrl = reader.result;
			document.getElementById("srcImg").src=dataUrl;
			convert();
		}
	});
}
var convert=function(){
	var srcImg=document.getElementById("srcImg");

	ctx.drawImage(srcImg,0,0,srcImg.width,srcImg.height,0,0,canvas.width,canvas.height)

	var srcimg=ctx.getImageData(0,0,canvas.width,canvas.height);
	var dstwidth=canvas.width;
	var dstheight=canvas.height;
	var dst = ctx.createImageData(dstwidth,dstheight);
	var dstdata=dst.data;
	var srcdata=srcimg.data;

	var uv=new Vec2();
	var angle=new Vec3();

	var x,y,u,v;
	var angle2uv=[
		polerAngle2Uv
		,boxAngle2Uv
		,sphereAngle2Uv
		,exAngle2Uv
		,box2Angle2Uv
	][document.getElementById("fromtype").selectedIndex];

	var uv2angle=[
		polerUv2Angle
		,boxUv2Angle
		,sphereUv2Angle
		,exUv2Angle
		,box2Uv2Angle
	][document.getElementById("totype").selectedIndex];

	for(y=0;y<dstheight;y++){
		for(x=0;x<dstwidth;x++){
			uv[0]=(x)/dstwidth;
			uv[1]=(y)/dstheight;

			uv2angle(angle,uv);
			angle2uv(uv,angle);

			u=(uv[0]*srcimg.width)|0;
			v=(uv[1]*srcimg.height)|0;
			var srcidx=(v*srcimg.width+u)*4
			var dstidx=(y*dstwidth+x)*4
			dstdata[dstidx]=srcdata[srcidx]
			dstdata[dstidx+1]=srcdata[srcidx+1]
			dstdata[dstidx+2]=srcdata[srcidx+2]
			dstdata[dstidx+3]=srcdata[srcidx+3]
			//dstdata[dstidx]=angle[0]*128+128|0
			//dstdata[dstidx+1]=angle[1]*128+128|0
			//dstdata[dstidx+2]=angle[2]*128+128|0
			//dstdata[dstidx+3]=255;
		}
	}
	ctx.putImageData(dst,0,0);
	document.getElementById("i").src=canvas.toDataURL("image/png");
//		});
}
var atan2=Math.atan2;
var asin=Math.asin;
var PI=Math.PI;
var _PI = 1/PI;
var _PI05=_PI*0.5;
var sqrt=Math.sqrt;
var _sqrt2=1.0/Math.sqrt(2);
var sqrt32=Math.sqrt(32);
var _sqrt32=sqrt(1/32);

var polerAngle2Uv=function(uv,angle){
	uv[0]=atan2(angle[0],-angle[2])*_PI05+0.5;
	uv[1]=-asin(angle[1])*_PI+0.5;
}
var polerUv2Angle=function(angle,uv){
	angle[1]=-Math.sin((uv[1]-0.5)*Math.PI)
	var l=sqrt(1-angle[1]*angle[1])
	var r=-uv[0]*Math.PI*2
	angle[0]=Math.sin(r)*l
	angle[2]=Math.cos(r)*l
}
var sphereAngle2Uv=function(uv,angle){

	uv[0]=angle[0]*0.5+0.5;
	uv[1]=angle[2]*0.5+0.5;

	uv[0]=(uv[0]+(((-angle[1]*(1<<30))>>30)&1))*0.5;
}
var sphereUv2Angle=function(angle,uv){
	var u=uv[0];
	var v=uv[1]
	angle[2]=v*2-1;
	if(u<0.5){
		angle[0]=u*4-1;
	}else{
		angle[0]=(u-0.5)*4-1;
	}
	var l=1.//Math.pow(angle[0]*angle[0]+angle[2]*angle[2],1./4.);
	angle[0]*=l;
	angle[2]*=l;
	
	if(angle[0]*angle[0]+angle[2]*angle[2]>1){
		angle[1]=0;
		Vec3.norm(angle);
	}else{
		angle[1]=-sqrt(1-angle[0]*angle[0]-angle[2]*angle[2]);
	}
	if(u>0.5){
		angle[1]*=-1;
	}
		Vec3.norm(angle);
}
var boxAngle2Uv=function(uv,angle){
	var x=angle[0];
	var y=angle[1];
	var z=angle[2];
	var u,v;
	if(y*y>x*x && y*y>z*z){
		x/=Math.abs(y);
		z/=Math.abs(y);
		if(y>0){
			u=0.25+0.125-x*0.125
			v=0.5+0.25+z*0.25
		}else{
			u=0.125-x*0.125
			v=0.5+0.25-z*0.25
		}
	}else{
		if(x*x>z*z){
			var orgz=z;
			var orgy=y;
			z/=Math.abs(x);
			y/=Math.abs(x);
			if(x<0){
				u=0.25+0.125-z*0.125
				v=0.25-y*0.25
			}else{
				u=0.25+0.5+0.125+z*0.125
				v=0.25-y*0.25
			}
		}else{
			x/=Math.abs(z);
			y/=Math.abs(z);
			if(z>0){
				u=0.125-x*0.125
				v=0.25-y*0.25
			}else{
				u=0.5+0.125+x*0.125
				v=0.25-y*0.25
			}
		}
	}
	uv[0]=u;
	uv[1]=v;

}
var boxUv2Angle=function(angle,uv){
	var xx=uv[0]*4;
	var yy=uv[1]*2;
	if(yy<1){
		yy=-(yy*2-1);
		angle[1]=yy;
		if(xx<1){
			angle[2]=1;
			angle[0]=-(xx*2-1);
		}else if(xx<2){
			xx-=1;
			angle[2]=-(xx*2-1);
			angle[0]=-1;
		}else if(xx<3){
			xx-=2;
			angle[2]=-1;
			angle[0]=xx*2-1;
		}else{
			xx-=3;
			angle[2]=(xx*2-1);
			angle[0]=1;
		}
	}else{
		yy-=1;
		yy=-(yy*2-1);
		if(xx<1){
			angle[1]=-1;
			angle[0]=-(xx*2-1);
			angle[2]=yy;
		}else if(xx<2){
			xx-=1;
			angle[1]=1;
			angle[0]=-(xx*2-1);
			angle[2]=-yy;
		}else{
			angle[1]=1;
			angle[0]=1;
			angle[2]=1;
		}
	}
	Vec3.norm(angle);
}

var exUv2Angle=function(angle,uv){
	var quad=((uv[0]+0.125)*4)|0;
	var y=1.0-2.0*uv[1];

	var val=((quad&2)-1)*(uv[0]-0.25*quad)*sqrt32;
	if(0<=(val*val)*2+y*y-1){
		angle[0]=0;
		angle[1]=-0.9;
		angle[2]=0;
	}else{
		angle[1]=y;
		angle[(quad&1)<<1]=val;
		angle[((~quad)&1)<<1]=(((quad-1)&2)-1)*sqrt(1-y*y-val*val)
	}
}
var exAngle2Uv=function(uv,angle){
	
	uv[1]=(1-angle[1])*0.5;
	var a=angle[0]*angle[0]*(1<<30)
	var b=angle[2]*angle[2]*(1<<30)
	var sign=((a-b)>>30)&1
	var sign2=((angle[0]*(1<<30))>>30)&1
	var sign3=((angle[2]*(1<<30))>>30)&1
	var u =-angle[0]*(1-sign3*2)*(sign)+angle[2]*(1-sign2*2)*(1-sign)

	var quad=sign3*2*sign+(1-sign)*((1-sign2)*2+1);
	uv[0]=quad*0.25+u*_sqrt32
	if(uv[0]<0){
		uv[0]+=1;
	}
	
}
var box2Angle2Uv=function(uv,angle){
	var s1=(angle[0]*angle[0]-angle[1]*angle[1])*(1<<30)&1;
	var s2=(angle[1]*angle[1]-angle[2]*angle[2])*(1<<30)&1;
	var s3=(angle[1]*angle[1]-angle[2]*angle[2])*(1<<30)&1;
	var s2=angle[0]*angle[0]-angle[2]*angle[2];
	s2=s2*(1<<30)&1;
	var yy=uv[1]*2|0;
	var u=(uv[0]-(xx*0.25)-0.125)*8*_sqrt2;
	var v=(uv[1]-(yy*0.5)-0.25)*4*_sqrt2;
	var n=Math.sqrt(1-u*u-v*v)
	
	var s1=(xx&1);
	var s4=(yy&1);
	var s2=(1-s1)*((xx&2)-1)*(1-s4);
	var s3=(s1)*(((xx-1)&2)-1)*(1-s4);
	var s5=s4*((xx&2)-1)

	angle[0]=(s2*u + s3*n) + (s5)*u;
	angle[1]=(-v)*(1-s4) +s5*n;
	angle[2]=(-s2*n + s3*u) -s4*v ;

	uv[0]=u;
	uv[1]=v;

}
var box2Uv2Angle=function(angle,uv){
	var xx=uv[0]*4|0;
	var yy=uv[1]*2|0;
	var u=(uv[0]-(xx*0.25)-0.125)*8*_sqrt2;
	var v=(uv[1]-(yy*0.5)-0.25)*4*_sqrt2;
	var n=Math.sqrt(1-u*u-v*v)
	
	var s1=(xx&1);
	var s4=(yy&1);
	var s2=(1-s1)*((xx&2)-1)*(1-s4);
	var s3=(s1)*(((xx-1)&2)-1)*(1-s4);
	var s5=s4*((xx&2)-1)

	angle[0]=(s2*u + s3*n) + (s5)*u;
	angle[1]=(-v)*(1-s4) +s5*n;
	angle[2]=(-s2*n + s3*u) -s4*v ;
}

	var uu=new Vec3();
	var vv=new Vec3();
	uu[0]=1;
	uu[1]=1;
	vv[0]=1;
	vv[1]=1;
	vv[2]=1;
	Vec2.norm(uu);
	Vec3.norm(vv);
	var t=Date.now();
	var i;
	for(i=0;i<100000;i++){
	//	polerAngle2Uv(uu,vv);
		//sphereAngle2Uv(uu,vv);
		boxAngle2Uv(uu,vv);
	}
	t=Date.now()-t;

	var t2=Date.now();
	for(i=0;i<100000;i++){
		exAngle2Uv(uu,vv);
	}
	t2=Date.now()-t2;
//	alert((t/1000)+","+(t2/1000));
</script>

<body onLoad="onloadfunc(event)">
<input type="file" id="selfile">
From:<select id="fromtype">
<option selected>poler</option>
<option >box</option>
<option >sphere</option>
<option >ex1</option>
<option >box2</option>
</select>
To:<select id="totype"> 
<option >poler</option>
<option >box</option>
<option >sphere</option>
<option  >ex1</option>
<option  selected>box2</option>
</select>
<input type="button" value="convert" onclick="convert()">
<img src="" id="srcImg"/><br />
<div id="main"><canvas id="maincanvas" width="1024" height="512" style="display:none;">
</canvas>
<br />
<img id="i">
</div>
</body>
</html>

