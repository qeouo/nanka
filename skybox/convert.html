<html
<head>
<title>skybox convert</title>
</head>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript" src="../lib/vector.js"></script>
<script type="text/javascript">
"use strict"
var ctx,canvas;
var onloadfunc=function(e){
	canvas =  document.getElementById('maincanvas')
	ctx =  canvas.getContext('2d')
	Util.init(canvas,document.getElementById('main'));

	var obj1=document.getElementById("selfile");
	obj1.addEventListener("change",function(evt){
		var file=evt.target.files;
		var reader=new FileReader();
		reader.readAsDataURL(file[0]);
		reader.onload=function(){
			var dataUrl = reader.result;
			document.getElementById("srcImg").src=dataUrl;
			convert();
		}
	});
}
var convert=function(){
	var srcImg=document.getElementById("srcImg");

	ctx.drawImage(srcImg,0,0,srcImg.width,srcImg.height,0,0,canvas.width,canvas.height)

	var srcimg=ctx.getImageData(0,0,canvas.width,canvas.height);
	var dstwidth=canvas.width;
	var dstheight=canvas.height;
	var dst = ctx.createImageData(dstwidth,dstheight);
	var dstdata=dst.data;
	var srcdata=srcimg.data;

	var uv=new Vec2();
	var angle=new Vec3();

	var x,y,u,v;
	var angle2uv=[
		polerAngle2Uv
		,boxAngle2Uv
		,sphereAngle2Uv
		,poler2Angle2Uv
		,exAngle2Uv
	][document.getElementById("fromtype").value];

	var uv2angle=[
		polerUv2Angle
		,boxUv2Angle
		,sphereUv2Angle
		,poler2Uv2Angle
		,exUv2Angle
	][document.getElementById("totype").value];

	for(y=0;y<dstheight;y++){
		for(x=0;x<dstwidth;x++){
			uv[0]=(x)/dstwidth;
			uv[1]=(y)/dstheight;

			uv2angle(angle,uv);
			angle2uv(uv,angle);

			u=(uv[0]*srcimg.width)|0;
			v=(uv[1]*srcimg.height)|0;
			var srcidx=(v*srcimg.width+u)*4
			var dstidx=(y*dstwidth+x)*4
			dstdata[dstidx]=srcdata[srcidx]
			dstdata[dstidx+1]=srcdata[srcidx+1]
			dstdata[dstidx+2]=srcdata[srcidx+2]
			dstdata[dstidx+3]=srcdata[srcidx+3]
			//dstdata[dstidx]=angle[0]*128+128|0
			//dstdata[dstidx+1]=angle[1]*128+128|0
			//dstdata[dstidx+2]=angle[2]*128+128|0
			//dstdata[dstidx+3]=255;
		}
	}
	ctx.putImageData(dst,0,0);
	document.getElementById("i").src=canvas.toDataURL("image/png");
//		});
}
var polerAngle2Uv=function(uv,angle){
	uv[0]=-Math.atan2(angle[0],angle[2])/Math.PI*0.5;
	if(uv[0]<0)uv[0]+=1;
	if(uv[0]>1)uv[0]-=1;
	uv[1]=-Math.asin(angle[1])/Math.PI+0.5;
	if(uv[1]<0)uv[1]+=1;
	if(uv[1]>1)uv[1]-=1;
}
var polerUv2Angle=function(angle,uv){
	angle[1]=-Math.sin((uv[1]-0.5)*Math.PI)
	var l=Math.sqrt(1-angle[1]*angle[1])
	var r=-uv[0]*Math.PI*2
	angle[0]=Math.sin(r)*l
	angle[2]=Math.cos(r)*l
}
var poler2Angle2Uv=function(uv,angle){
	uv[0]=-Math.atan2(angle[0],angle[2])/Math.PI*0.5;
	uv[1]=-Math.asin(angle[1])/Math.PI+0.5;
}
var poler2Uv2Angle=function(angle,uv){
	angle[1]=-Math.sin((uv[1]-0.5)*Math.PI)
	var l=Math.sqrt(1-angle[1]*angle[1])
	var r=-uv[0]*Math.PI*2
	angle[0]=Math.sin(r)*l
	angle[2]=Math.cos(r)*l
}
var sphereAngle2Uv=function(uv,angle){
	var l=1//(angle[0]*angle[0]+angle[2]*angle[2])
	uv[0]=angle[0]*l
	uv[1]=angle[2]*l

	uv[0]=uv[0]*0.5+0.5;
	uv[1]=uv[1]*0.5+0.5;

	uv[0]*=0.5;
	if(angle[1]>0){
		uv[0]+=0.5;
	}
}
var sphereUv2Angle=function(angle,uv){
	var u=uv[0];
	var v=uv[1]
	angle[2]=v*2-1;
	if(u<0.5){
		angle[0]=u*4-1;
	}else{
		angle[0]=(u-0.5)*4-1;
	}
	var l=1.//Math.pow(angle[0]*angle[0]+angle[2]*angle[2],1./4.);
	angle[0]*=l;
	angle[2]*=l;
	
	if(angle[0]*angle[0]+angle[2]*angle[2]>1){
		angle[1]=0;
		Vec3.norm(angle);
	}else{
		angle[1]=-Math.sqrt(1-angle[0]*angle[0]-angle[2]*angle[2]);
	}
	if(u>0.5){
		angle[1]*=-1;
	}
		Vec3.norm(angle);
}
var boxAngle2Uv=function(uv,angle){
	var x=angle[0];
	var y=angle[1];
	var z=angle[2];
	var u,v;
	if(y*y>x*x && y*y>z*z){
		x/=Math.abs(y);
		z/=Math.abs(y);
		if(y>0){
			u=0.25+0.125-x*0.125
			v=0.5+0.25+z*0.25
		}else{
			u=0.125-x*0.125
			v=0.5+0.25-z*0.25
		}
	}else{
		if(x*x>z*z){
			var orgz=z;
			var orgy=y;
			z/=Math.abs(x);
			y/=Math.abs(x);
			if(x<0){
				u=0.25+0.125-z*0.125
				v=0.25-y*0.25
			}else{
				u=0.25+0.5+0.125+z*0.125
				v=0.25-y*0.25
			}
		}else{
			x/=Math.abs(z);
			y/=Math.abs(z);
			if(z>0){
				u=0.125-x*0.125
				v=0.25-y*0.25
			}else{
				u=0.5+0.125+x*0.125
				v=0.25-y*0.25
			}
		}
	}
	uv[0]=u;
	uv[1]=v;

}
var boxUv2Angle=function(angle,uv){
	var xx=uv[0]*4;
	var yy=uv[1]*2;
	if(yy<1){
		yy=-(yy*2-1);
		angle[1]=yy;
		if(xx<1){
			angle[2]=1;
			angle[0]=-(xx*2-1);
		}else if(xx<2){
			xx-=1;
			angle[2]=-(xx*2-1);
			angle[0]=-1;
		}else if(xx<3){
			xx-=2;
			angle[2]=-1;
			angle[0]=xx*2-1;
		}else{
			xx-=3;
			angle[2]=(xx*2-1);
			angle[0]=1;
		}
	}else{
		yy-=1;
		yy=-(yy*2-1);
		if(xx<1){
			angle[1]=-1;
			angle[0]=-(xx*2-1);
			angle[2]=yy;
		}else if(xx<2){
			xx-=1;
			angle[1]=1;
			angle[0]=-(xx*2-1);
			angle[2]=-yy;
		}else{
			angle[1]=1;
			angle[0]=1;
			angle[2]=1;
		}
	}
	Vec3.norm(angle);
}

var exUv2Angle=function(angle,uv){
	var a=((uv[0]+0.125)*4)|0;
	angle[1]=1.0-2.0*uv[1];
	var len=8/Math.sqrt(2)//*Math.sqrt(1-angle[1]*angle[1]);
	switch(a){
	case 0:
	case 4:
		angle[0]=-(uv[0]-0.25*a)*len;
		angle[2]=Math.sqrt(1-angle[1]*angle[1]-angle[0]*angle[0])
		break;
	case 1:
		angle[2]=-(uv[0]-0.25*a)*len;
		angle[0]=-Math.sqrt(1-angle[1]*angle[1]-angle[2]*angle[2])
		break;
	case 2:
		angle[0]=(uv[0]-0.25*a)*len;
		angle[2]=-Math.sqrt(1-angle[1]*angle[1]-angle[0]*angle[0])
		break;
	case 3:
		angle[2]=(uv[0]-0.25*a)*len;
		angle[0]=Math.sqrt(1-angle[1]*angle[1]-angle[2]*angle[2])
		break;
	}
}
var exAngle2Uv=function(angle,uv){
	var sx=angle[0]*angle[0]-angle[2]*angle[2]
	var sy=(angle[1]>>30)&0x1
	
	Vec3.norm(angle);
}
</script>

<body onLoad="onloadfunc(event)">
<input type="file" id="selfile">
From:<select id="fromtype">
<option value="0">poler</option>
<option value="1">box</option>
<option value="2">sphere</option>
<option value="3">poler2</option>
<option value="4">ex1</option>
</select>
To:<select id="totype"> 
<option value="0">poler</option>
<option value="1">box</option>
<option value="2">sphere</option>
<option value="3">poler2</option>
<option value="4" selected>ex1</option>
</select>
<input type="button" value="convert" onclick="convert()">
<img src="" id="srcImg"/><br />
<div id="main"><canvas id="maincanvas" width="1024" height="512" style="display:none;">
</canvas>
<br />
<img id="i">
</div>
</body>
</html>

