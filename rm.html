<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<body >
<div id="fps"></div>
<canvas id="c" width="160" height="90" style="border:solid 1px black;width:320px;height:180px;">
</canvas>
</body>
<script type="text/javascript">
"use strict"

var canvas= document.getElementById('c');
var ctx = canvas.getContext('2d');
var WIDTH = canvas.width;
var WIDTH05 = WIDTH*0.5;
var HEIGHT = canvas.height;
var HEIGHT05 = HEIGHT*0.5
var IWIDTH = 1 / WIDTH;
var STEPMAX = 32;
var FPS = 15;
var MPF = 1000 / FPS | 0;

var frame=0;
var time = 0;
var R, G, B;
var cameraX = 100, cameraY = 0, cameraZ = 100;
var m0, m1, m2, m3, m4, m5, m6, m7, m8, m9;

var divfps = document.getElementById('fps');
var oldTime = 0
var totalFrame = 0;
var truefps=0;

var imagedata = ctx.createImageData(WIDTH, HEIGHT);
var data = imagedata.data;
for (var i = WIDTH * HEIGHT * 4 - 1; i >= 0; i -= 4) { data[i] = 255; }

var ransu = []
for (i = 256; i--;) { ransu.push(Math.random()); }
var rnd = function (a, b, c) {
	return ransu[a * 123.456789 + b * 34.5678901 + c * 5.67890123  & 255]; //tekitou
}

var df = function (x, y, z) {
	var d = 100000, d2;
	var l, xx, yy, zz;

	for (var i = 0; i < 2; i++) {
		l = rnd(x | 0, z | 0, 0) + time;
		l = l - (l | 0) - 0.5;
		if (l < 0) l = -l;

		xx = x - (x | 0) - (x>>30) - 0.5
		zz = z - (z | 0) - (z>>30) - 0.5

		yy = y + 4 + l;

		if (xx < 0) xx = -xx;
		if (yy < 0) yy = -yy;
		if (zz < 0) zz = -zz;
		xx -= 0.25;
		if (xx < 0) xx = 0;
		yy -= 0.25;
		if (yy < 0) yy = 0;
		zz -= 0.25;
		if (zz < 0) zz = 0;
		d2 = Math.sqrt(xx * xx + yy * yy + zz * zz) - 0.2;

		if (d2 < d) d = d2;
		y = -y;
		x = -x;
	}
	return d;
}

var ray = function (x, y, t) {
	var i, d, rx, ry, rz, px, py, pz,totald=0;

	x = (x - WIDTH05) *  IWIDTH;
	y = -((y - HEIGHT05) * IWIDTH);
	d=2 / (1.01 - (x * x + y * y))
	x *= d
	y *= d

	rx = m0 * x + m3 * y + m6;
	ry = m1 * x + m4 * y + m7;
	rz = m2 * x + m5 * y + m8;
	d = 1 / Math.sqrt(rx * rx + ry * ry + rz * rz);
	rx *= d;
	ry *= d;
	rz *= d;

	px = cameraX;
	py = cameraY;
	pz = cameraZ;

	for (i = 0;i< STEPMAX; i++) {
		d = df(px, py, pz, t);
		if (d < 0.01) {
			break;
		}
		totald += d;
		if (d > 20) {
			i = STEPMAX
			break;
		}
		px += rx * d;
		py += ry * d;
		pz += rz * d;
	}
	d = 1 - (i / STEPMAX);
	if(d > 0) d += 0.1;
	R = d * rnd(px | 0, pz | 0, 1);
	G = d * rnd(px | 0, pz | 0, 2);
	B = d * rnd(px | 0, pz | 0, 3);
}

var mainloop = function (e) {
	var startTime = new Date();
	var p, i, j, d;
	time = frame / FPS;

	cameraZ += 0.2;
	cameraY = Math.sin(time*0.3) * 2;

	m6 = Math.sin(time * 0.3) * 0.5;
	m7 = Math.cos(time * 0.6) *0.4;
	m8 = Math.sqrt(1 - m6 * m6 + m7 * m7 );
//	d = 1 / Math.sqrt(m6 * m6 + m7 * m7 + m8 * m8);
//	m6 *= d;
//	m7 *= d;
//	m8 *= d;

	m3 = Math.cos(frame * 0.01);
	m4 = Math.sin(frame * 0.01);
	m5 = 0;

	m0 = m4 * m8 - m5 * m7;
	m1 = m5 * m6 - m3 * m8;
	m2 = m3 * m7 - m4 * m6;
	d = 1 / Math.sqrt(m0 * m0 + m1 * m1 + m2 * m2);
	m0 *= d;
	m1 *= d;
	m2 *= d;

	m3 = m7 * m2 - m8 * m1;
	m4 = m8 * m0 - m6 * m2;
	m5 = m6 * m1 - m7 * m0;
//	d = 1 / Math.sqrt(m3 * m3 + m4 * m4 + m5 * m5);
//	m3 *= d;
//	m4 *= d;
//	m5 *= d;

	p = 0;
	for (j = 0; j < HEIGHT; j++) {
		for (i = 0; i < WIDTH; i++) {
			ray(i, j)
			data[p + 0] = R * 255;
			data[p + 1] = G * 255;
			data[p + 2] = B * 255;
			p += 4
		}
	}
	ctx.putImageData(imagedata, 0, 0);

	var endTime = new Date();
	totalFrame++;
	frame++;
	if(endTime - oldTime >= 1000){
		truefps = Math.round(totalFrame / (endTime-oldTime) * 100000) / 100;
		totalFrame = 0;
		oldTime = endTime;
	}

	var dt = endTime - startTime;
	var wait = MPF - dt;
	if (wait < 0){
		wait = 0;
		divfps.style.color = "red";
	}else{
		divfps.style.color = "black";
	}
	divfps.innerHTML = "processing time : " + dt + "msec/frame" + " (" + truefps + "fps)";

	setTimeout(mainloop, wait);
}

mainloop();
</script>
