<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
<title>between</title>
</head>
<body >
<canvas id="c" width="160" height="90" style="border:solid 1px black;width:320px;height:180px;">
</canvas>

</body>
<script type="text/javascript">
"use strict"
var canvas=  document.getElementById('c');
var ctx = canvas.getContext('2d');
var WIDTH=canvas.width;
var HEIGHT=canvas.height;
var WIDTH4 = WIDTH * 4;
var IWIDTH = 1 / WIDTH;
var STEPMAX = 32;

var frame = 0;
var R, G, B;
var cameraX = 100, cameraY = 0, cameraZ = 100;
var m0, m1, m2, m3, m4, m5, m6, m7, m8, m9;

var imagedata = ctx.createImageData(WIDTH, HEIGHT);
var data = imagedata.data;
for (var i = WIDTH * HEIGHT * 4 - 1; i >= 0; i -= 4) { data[i] = 255; }

var ransu = []
for (i = 0x100; i--;) { ransu.push(Math.random()); }
var rnd = function (a, b, c) {
	return ransu[(a | 0) * 123.45678 + (b | 0) * 345.6789 + (c | 0) * 567.8901  & 0xff]; //tekitou
}

var df = function (x, y, z) {
	var d = 100000, d2;
	var l, xx, yy, zz;

	for (var i = 0; i < 2; i++) {
		l = rnd(x, z, 0) + frame * 0.05;
		l = l - (l | 0) - 0.5;
		if (l < 0) l = -l;

		xx = (x >= 0) ? x - (x | 0) : x - (x | 0) + 1;
		zz = (z >= 0) ? z - (z | 0) : z - (z | 0) + 1;
		xx -= 0.5;
		zz -= 0.5;

		yy = y + 4 + l;

		if (xx < 0) xx = -xx;
		if (yy < 0) yy = -yy;
		if (zz < 0) zz = -zz;
		xx -= 0.3;
		if (xx < 0) xx = 0;
		yy -= 0.3;
		if (yy < 0) yy = 0;
		zz -= 0.3;
		if (zz < 0) zz = 0;
		d2 = Math.sqrt(xx * xx + yy * yy + zz * zz) - 0.15;

		if (d2 < d) d = d2;
		y = -y;
		x = -x;
	}
	return d;
}

var ray = function (x, y, t) {
	var i, d, rx, ry, rz, px, py, pz;

	x = x * IWIDTH - 0.5;
	y = -(y * IWIDTH - 0.5);

	rx = m0 * x + m3 * y + m6;
	ry = m1 * x + m4 * y + m7;
	rz = m2 * x + m5 * y + m8;
	d = 1 / Math.sqrt(rx * rx + ry * ry + rz * rz);
	rx *= d;
	ry *= d;
	rz *= d;

	px = cameraX;
	py = cameraY;
	pz = cameraZ;

	for (i = STEPMAX; i--;) {
		d = df(px, py, pz, t);
		if (d < 0.01) {
			break;
		}
		if ((pz - cameraZ) > 20) {
			i = 0
			break;
		}
		px += rx * d;
		py += ry * d;
		pz += rz * d;
	}
	d = (i / STEPMAX);
	if(d>0)d+=0.1;
	R = d * rnd(px, pz, 1);
	G = d * rnd(px, pz, 2);
	B = d * rnd(px, pz, 3);
}
var mainloop = function (e) {
	var startTime = new Date();
	var p, i, j, d;

	cameraZ += 0.2;
	cameraY = Math.sin(frame * 0.01) * 2;

	m6 = Math.cos(frame * 0.01) * 0.5;
	m7 = Math.sin(frame * 0.02);
	m8 = 1;
	d = 1 / Math.sqrt(m6 * m6 + m7 * m7 + m8 * m8);
	m6 *= d;
	m7 *= d;
	m8 *= d;

	m3 = Math.sin(frame * 0.01);
	m4 = Math.cos(frame * 0.01);
	m5 = 0;

	m0 = m4 * m8 - m5 * m7;
	m1 = m5 * m6 - m3 * m8;
	m2 = m3 * m7 - m4 * m6;
	d = 1 / Math.sqrt(m0 * m0 + m1 * m1 + m2 * m2);
	m0 *= d;
	m1 *= d;
	m2 *= d;

	m3 = m7 * m2 - m8 * m1;
	m4 = m8 * m0 - m6 * m2;
	m5 = m6 * m1 - m7 * m0;
	d = 1 / Math.sqrt(m3 * m3 + m4 * m4 + m5 * m5);
	m3 *= d;
	m4 *= d;
	m5 *= d;

	p = 0;
	for (j = 0; j < HEIGHT; j++) {
		for (i = 0; i < WIDTH; i++) {
			ray(i, j)
			data[p + 0] = R * 255;
			data[p + 1] = G * 255;
			data[p + 2] = B * 255;
			p += 4
		}
	}
	ctx.putImageData(imagedata, 0, 0);

	var wait = 66 - (new Date() - startTime);
	if (wait <= 0) wait = 1;
	setTimeout(mainloop, wait);
	frame++;
}

mainloop();
</script>
