<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<meta charset="utf-8">
</head>
<body >
	<div id="hoge"></div>
	<canvas id="c" width=256 height=256 style="border:solid 1px black;"></canvas>
</body>
<script type="text/javascript">
var Vec2 = function(){
	this[0]=0;
	this[1]=0;
}
var add=function(a,b,c){a[0]=b[0]+c[0];a[1]=b[1]+c[1];}
var sub=function(a,b,c){a[0]=b[0]-c[0];a[1]=b[1]-c[1];}
var mul=function(a,b,c){a[0]=b[0]*c;a[1]=b[1]*c;}
var muladd=function(a,b,c,d){a[0]=b[0]+c[0]*d;a[1]=b[1]+c[1]*d;}
var dot = function(a,b){return a[0]*b[0]+a[1]*b[1];}

var Obj=function(){
	this.p=new Vec2();
	this.v=new Vec2();
	this.f=new Vec2();
	this.m=0.01;
	this.size=0.1;
}
var HitData=function(){
	this.a = null;
	this.b = null;
	this.ap = new Vec2();
	this.bp = new Vec2();
	this.n = new Vec2();
}
var MAX=20;
var hitDatas =[];
for(var i=MAX*(MAX+1)/2;i--;){
	hitDatas.push(new HitData());
}
var STEP=2;
var PENA =1*STEP;
var SOL = 100;
var G = 9.8;
var obj= [];
for(var i=0;i<MAX;i++){
	var o = new Obj();
	obj.push(o);
	o.p[0] = 128*0.01+((Math.random()-0.5)*1);
	o.p[1] = 128*0.01 - i*0.3;
}
obj[0].m=99999;
obj[0].p[0]=0*0.01;
obj[0].p[1]=300*0.01;
obj[0].size=150*0.01;
obj[1].m=99999;
obj[1].p[0]=256*0.01;
obj[1].p[1]=300*0.01;
obj[1].size=150*0.01;
obj[2].m=99999;
obj[2].p[0]=0*0.01;
obj[2].p[1]=100*0.01;
obj[2].size=50*0.01;
obj[3].m=99999;
obj[3].p[0]=256*0.01;
obj[3].p[1]=100*0.01;
obj[3].size=50*0.01;

var ctx=document.getElementById("c").getContext("2d");
var dp = new Array(2);
var dv_ = new Array(2);
var dv = new Array(2);
var n = new Array(2);
var fo = new Array(2);
var f = function(dt){
	for(var i=0;i<MAX;i++){
		var o = obj[i];
		o.f[1] = G*o.m;
		if(o.m>9999){continue;}
		muladd(o.v,o.v,o.f,dt/o.m);
		
	}
	var hitCount=0;
	for(var i=0;i<MAX;i++){
		var o = obj[i];
		for(var j=i+1;j<MAX;j++){
			var o2 = obj[j];
			sub(dp,o.p,o2.p);
			
			if(dp[0]*dp[0]+dp[1]*dp[1]<(o.size+o2.size)*(o.size+o2.size)){
				var hitData =hitDatas[hitCount];
				hitData.a=o;
				hitData.b=o2;
				var d = Math.sqrt(dp[0]*dp[0]+dp[1]*dp[1])
				mul(hitData.n,dp,1/d);
				muladd(hitData.ap,o.p,hitData.n,-o.size);
				muladd(hitData.bp,o2.p,hitData.n,-o2.size);
				hitCount++;
			}
		}
	}
	hitDatas[hitCount].a=null;
	for(var k=0;k<SOL;k++){
		for(var i=0;i<MAX;i++){
			var o = obj[i];
			mul(o.f,o.f,0);
		}
		for(var i=hitCount;i--;){
			var hitData = hitDatas[i];
			var o= hitData.a;
			var o2= hitData.b;

			sub(dv_,o.v,o2.v);
			mul(dv,hitData.n,dot(dv_,hitData.n));
			var m = o.m*o2.m/(o.m+o2.m);
		
			fo[0]=0;
			fo[1]=0;
			if(k==SOL-1){
				sub(dp,hitData.ap,hitData.bp);
				muladd(fo,fo,dp,-PENA);
			}
			
			var e=0.0;
			if(dot(dv_,n)<0){
				muladd(fo,fo,dv,-(e+1.0)*m/dt);
			}
			add(o.f,o.f,fo);
			muladd(o2.f,o2.f,fo,-1);
		}
		for(var i=0;i<MAX;i++){
			var o = obj[i];
			if(o.m>9999){continue;}
				muladd(o.v,o.v,o.f,dt/o.m);
		
		}
	}
	for(var i=0;i<MAX;i++){
		var o = obj[i];
		if(o.v[0]*o.v[0] + o.v[1]*o.v[1]<0.0001){
			o.v[0]=0;
			o.v[1]=0;
		}
		muladd(o.p,o.p,o.v,dt);
	}
}
var timesum=0;
var framecount=0;
		var fps=0;
var ml= function(){

	var n=STEP;
	var start=Date.now();
	for(var i=0;i<n;i++){
		f(0.033/n);
	}

	ctx.clearRect(0,0,256,256);
	ctx.strokeStyle="black";
	for(var i=0;i<MAX;i++){
		var o = obj[i];
		var size = o.size*100;
		ctx.beginPath();
		ctx.arc(o.p[0]*100,o.p[1]*100,size,Math.PI*2,false);
		ctx.closePath();
		ctx.stroke();
	}
	timesum+=(+Date.now()-start);
	framecount++;
	if(framecount==30){
		fps=timesum/30.0;
		framecount=0;
		timesum=0;
	}
	document.getElementById("hoge").innerHTML = fps;
	setTimeout(ml,33);
}

ml();

</script>
