
<!-- ごくろうさまです -->

<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<title>bc</title>
<link rel="stylesheet" href="b.css">

</head>

<body onLoad="onloadfunc(event)">

	<div class="header">
		<span class="bui"></span>
		<span class="buso"></span>
		<span class="rarelity"></span>
		<span class="header status atk"></span>
		<span class="header status def"></span>
		<span class="header status spd"></span>
		<span class="header status lp"></span>
		<span class="header status bst"></span>
	</div>

	<div><span class="shinki template_buso" id="shinki" ></span><span class="biko" bind="biko"></span></div>
	<div style="margin-bottom:4px;">
		<span class="bui header"></span>
		<span class="rarelity"></span>
		<span style="width:200px;text-align:right;">
			<span>アイコン</span>
			<select id="individual" style="width:100px">
			</select>
		</span>
		<span class="param" bind="individual">
		</span>
	</div>
	<div><span class="template_buso" id="head" ></span></div>
	<div><span class="template_buso" id="body" ></span></div>
	<div><span class="template_buso" id="arm" ></span></div>
	<div><span class="template_buso" id="leg" ></span></div>
	<div><span class="template_buso" id="rear" ></span></div>
	<div><span class="template_buso" id="weapon"></span></div>
	<div class="sub"><span class="template_buso" id="sub"></div>

	<br>
	<div class="subtotal">
		<span class="bui"></span>
		<span class="rarelity"></span>
		<span class="buso">小計</span>
		<span class="param" bind="subtotal"></span>
		<span class="biko" bind="subtotal.biko"></span>
	</div>
	<br>
	<div class="total">
		<span class="bui"></span>
		<span class="rarelity"></span>
		<span class="buso">武器適正やパッシブ適用後</span>
		<span class="param" bind="total"></span>
	</div>


<div style="display:none;" id="template">

	<span id="buso" class="hoge">
		<span class="bui header"></span>
		<select class="buso">
		</select>
		<select  class="rarelity">
		</select>
			
		<span class="param">
		</span>
		<span class="biko"></span>
	</span>

	<select id="rarelity" >
		<option class="n" value="n">N</option>
		<option class="r" value="r">R</option>
		<option class="sr" value="sr">SR</option>
		<option class="ur" value="ur">UR</option>
	</select>

	<span id="param">
		<span class="status atk" bind="atk">1</span>
		<span class="status def" bind="def">2</span>
		<span class="status spd" bind="spd">3</span>
		<span class="status lp"  bind="lp">4</span>
		<span class="status bst" bind="bst">5</span>
	</span>
</div>

</body>

<script type="module">
"use strict"

import Data from "./b_data.js";

var controls={};
var values={total:{}};
var binds=[];

class Param{
	constructor(atk=0,def=0,spd=0,lp=0,bst=0){
		this.atk=atk;
		this.def=def;
		this.spd=spd;
		this.lp=lp;
		this.bst=bst;
	}
	set(atk,def,spd,lp,bst){
		this.atk=atk;
		this.def=def;
		this.spd=spd;
		this.lp=lp;
		this.bst=bst;
	}
}
var refreshBindData=function(){
	for(var i=0;i<binds.length;i++){
		const bind = binds[i];
		var value = values;
		for(var j=0;j<bind.variable.length;j++){
			value = value[bind.variable[j]];
			if(value == undefined){
				value="";
				break;
			}
		}
		bind.target.innerHTML = value;
	}
}
var add=function(a,b){
	a.atk += b.atk;
	a.def += b.def;
	a.spd += b.spd;
	a.lp += b.lp;
	a.bst += b.bst;
}

var reCalc=function(){
	var select = controls.buso_shinki;
	var r = select.parentNode.querySelector(".rarelity");
	var pussives=[];

	values.default_shinki_param = Data.default_shinki_param;
	//神姫
	var shinki= Data.shinkis.find((elem)=>{return elem.cd === select.value});
	if(shinki){
		values.shinki=new Param(0,0,0,0,0);
		add(values.shinki,shinki);
		add(values.shinki,Data.default_shinki_param);

		//レアリティ
		var cd = controls["shinki_rarelity"].value;
		add(values.shinki,Data.shinki_rarelity_bonus[cd]);

		var ap="";
		for(var i=0;i<shinki.apts.length;i++){
			var apt = shinki.apts[i];
			if(apt !==0){
				ap += " [" + Data.categories[i] + "]"+apt+"%";
			}
		}
		values.biko=ap;
	}
	//アイコン
	var cd = controls["individual"].value;
	var individual= Data.individuals[cd];
	values.individual=individual.param;

	

	for(var i=1;i<Data.bui_names.length;i++){
		var bui=Data.bui_names[i];
		var select = controls["buso_"+bui];
		var r = controls[bui + "_rarelity"].selectedIndex;

		var idx = Data.busos.findIndex((elem)=>{return elem.cd === select.value});
		var buso = Data.busos[idx+r];
		values[bui]=new Param(0,0,0,0,0);
		if(buso){
			add(values[bui],buso);
			if(buso.pussive>=0){
				values[bui].biko = Data.pussives[buso.pussive].name;

				pussives.push(Data.pussives[buso.pussive]);
			}
		}
	}

	var total={atk:0,def:0,spd:0,lp:0,bst:0};
	add(total,values.shinki);
	add(total,values.individual);
	add(total,values.head);
	add(total,values.body);
	add(total,values.arm);
	add(total,values.leg);
	add(total,values.rear);
	add(total,values.weapon);
	
	values.subtotal=total;

	var total2={atk:0,def:0,spd:0,lp:0,bst:0};
	values.total=total2;
	var cd =controls["buso_weapon"].value;
	var weapon= Data.busos.find((elem)=>{return elem.cd === cd});
	values.weapon.biko = "["+Data.categories[weapon.category]+"]";
	cd =controls["buso_sub"].value;
	var sub= Data.busos.find((elem)=>{return elem.cd === cd});
	values.sub.biko = "["+Data.categories[sub.category]+"]";
	var hose = shinki.apts[weapon.category];
	add(total2,total);
	total2.atk += Math.trunc(total2.atk * hose*0.01);

	//pussive
	values.subtotal.biko ="";
	if(hose!==0){
		values.subtotal.biko += " [" + Data.categories[weapon.category] + "]"+hose+"%";
	}
	for(var i=0;i<pussives.length;i++){
		values.subtotal.biko += " " + pussives[i].name;
		pussives[i].func(values);
	}

	refreshBindData();
}

window.onloadfunc=function(){

	//部位ごとの武装フォーム作成
	var divs= document.querySelectorAll(".template_buso");
	var divbuso=document.querySelector("#template #buso");
	for(var i=0;i<divs.length;i++){
		var org = divs[i];
		var bui = org.id;
		if(org === divbuso)continue;
		var div2 = divbuso.cloneNode(true);

		div2.id = org.id;
		div2.querySelector("select.buso").id="buso_"+org.id;
		div2.classList.add(org.id);
		div2.querySelector("select.rarelity").id=org.id+"_rarelity";

		div2.querySelector("span.param").setAttribute("bind",bui);
		div2.querySelector("span.biko").setAttribute("bind",bui+".biko");


		org.parentNode.replaceChild(div2,org);
	}

	//param
	var nodes= document.querySelectorAll("span.param");
	var param= document.getElementById("param");
	for(var i=0;i<nodes.length;i++){
		var node = nodes[i];
		var newnode = param.cloneNode(true);
		var bindName = node.getAttribute("bind");
		var children = newnode.children;
		for(var j=0;j<children.length;j++){
			children[j].setAttribute("bind",bindName +"."+children[j].getAttribute("bind"));
		}

		node.parentNode.replaceChild(newnode,node);
	}
	//レアリティコンボボックス設定
	var selects = document.querySelectorAll("select.rarelity");
	var rare = document.getElementById("rarelity");
	for(var i=0;i<selects.length;i++){
		if(selects[i].className ==="rarelity"){
			var rare2 = rare.cloneNode(true);
			rare2.addEventListener("change",function(){
				this.className="rarelity";
				this.classList.add(this.value);

			});

			rare2.value="n";
			rare2.className="rarelity n";
			rare2.id = selects[i].id;

			selects[i].parentNode.replaceChild(rare2,selects[i]);
		}
	}

	//部位ごとの武装セット
	for(var i=0;i<Data.bui_names.length;i++){
		var bui=Data.bui_names[i];
		var select= document.getElementById("buso_"+bui);
		for(var j=0;j<Data.busos.length;j++){
			var buso = Data.busos[j];
			if(buso.bui !== i && !(buso.bui===6 && i===7)){continue;};
			if(buso.rarelity !== 0){continue;};

			var option = document.createElement("OPTION");
			option.innerHTML = buso.name;
			option.value= buso.cd;
			select.appendChild(option);
		}

	}
	var select = document.getElementById("buso_shinki");
	for(var j=0;j<Data.shinkis.length;j++){
		var s = Data.shinkis[j];
		s.cd="shinki"+ ("00000"+j).slice(-5);

		var option = document.createElement("OPTION");
		option.innerHTML = s.name;
		option.value= s.cd;
		select.appendChild(option);
	}



	//バインド
	var bindedNodes = document.querySelectorAll("[bind]");
	for(var i=0;i<bindedNodes.length;i++){
		var bind={};
		bind.target = bindedNodes[i];
		bind.variable = bind.target.getAttribute("bind").split(".");
		binds.push(bind);
	}


	var nodes= document.querySelectorAll("select");
	for(var i=0;i<nodes.length;i++){
		nodes[i].addEventListener("change",function(){
			reCalc();
		});
		controls[nodes[i].id]=nodes[i];
	}

	var select = controls["individual"];
	for(var i=0;i<Data.individuals.length;i++){
		var individual= Data.individuals[i];
		var option = document.createElement("OPTION");
		option.innerHTML = individual.name;
		option.value= i;
		select.appendChild(option);
	}

	reCalc();
}



</script>
</html>


