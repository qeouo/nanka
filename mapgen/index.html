<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<title>mapgen</title>
<style>
</style>
<script type="text/javascript" src="../lib/inherits.js"></script>
<script type="text/javascript" src="../lib/util.js"></script>
<script type="text/javascript" src="../lib/vector.js"></script>
<script type="text/javascript" src="../lib/openexr.js"></script>
<script type="text/javascript" src="../lib/zip.js"></script>
<script type="text/javascript" src="../lib/slider.js"></script>
<script type="text/javascript" src="../lib/colorpicker.js"></script>
<script type="text/javascript" src="../lib/geono.js"></script>
<script type="text/javascript" src="../lib/img.js"></script>
<style>
canvas{
	background-color:gray;
}
</style>

<script type="text/javascript">
"use strict"

var endFlg=[];
var wave=[];
var SIZE=1;
var buf_img;
var N=3;
var HALF_N = N>>1;
var copy=function(img0,x0,y0,img1,x,y,w,h){
	for(var yi=0;yi<h;yi++){
		for(var xi=0;xi<w;xi++){
			var idx0 = img0.getIndex(x0+xi,y0+yi);
			var idx1 = img1.getIndex(x+xi,y+yi);
			img0.rgba[idx0] = img1.rgba[idx1];
		}
	}
}

var checkPixel = function(x,y,img0,px,py,img1){
	for(var yi=0;yi<N;yi++){
		for(var xi=0;xi<N;xi++){
			var idx = img0.getIndex(x+xi-HALF_N,y+yi-HALF_N);
			var idx1 = img1.getIndex(px+xi-HALF_N,py+yi-HALF_N);

			var col = img1.rgba[idx1];
			var wav = wave[idx];
			if(wav.length===0){
				//‘S‰Â”\«
				continue;
			}
			if(wav.indexOf(col)<0){
				return false;
			}
		}
	}
	return true;

}
var getPixel = function(x,y,main_img,pat){
	var count=0;
	var kouho=[];
	for(var py=0;py<pat.height;py++){
		for(var px=0;px<pat.width;px++){
			if(checkPixel(x,y,main_img,px,py,pat)){
				kouho.push([px,py]);
			}
		}
	}
	var idx0 = main_img.getIndex(x,y);
	if(kouho.length===0){
		main_img.rgba[idx0] = 0xffffff00;
		return;
	}
	var idx = Math.random() * kouho.length|0;

	var px=kouho[idx][0];
	var py=kouho[idx][1];

	//copy(main_img,x-HALF_N,y-HALF_N,pat,px-HALF_N,py-HALF_N,N,N);
	var idx1 = pat.getIndex(px,py);
	main_img.rgba[idx0] = pat.rgba[idx1];
	var col =  pat.rgba[idx1];
	for(var yi=0;yi<N;yi++){
		for(var xi=0;xi<N;xi++){
			var idx0 = main_img.getIndex(x+xi-HALF_N,y+yi-HALF_N);
			wave[idx0]=[];
			for(var ki=0;ki<kouho.length;ki++){
				var px=kouho[ki][0];
				var py=kouho[ki][1];
				var idx = pat.getIndex(px,py);
				if(col!==pat.rgba[idx]){
					continue;
				}
				px+=xi-HALF_N;
				py+=yi-HALF_N;
				idx = pat.getIndex(px,py);
				if(wave.indexOf(pat.rgba[idx])<0){
					wave[idx0].push(pat.rgba[idx]);
				}
	
			}
		}
	}
		
//	setPixel(x,y,main_img,px,py,pat);
//	main_img.data[ ((y) * main_img.width + (x)<<2)+3] = 0xff;
	
}
var onloadfunc=function(e){
	var imgs=[];
	imgs.push(Img.loadImg("pat.png",1));
	imgs.push(Img.loadImg("pat0.png",1));
	imgs.push(Img.loadImg("pat1.png",1));
	imgs.push(Img.loadImg("pat2.png",1));
	imgs.push(Img.loadImg("pat3.png",1));

	var s = document.getElementById("pat");
	for(var i=0;i<imgs.length;i++){
		var option =document.createElement("option");
		option.text=i;
		s.appendChild(option);
	}

	var act=function(img){

		var pat_img = img;
		var pat  =document.getElementById("img_pat");
		pat.src = img.toDataUrl();

		var canvas = document.getElementById("c");
		var main_img= new Img(canvas.width,canvas.height,1);

		buf_img= new Img(N,N,1);

	wave=new Array(main_img.width*main_img.height);
	for(var i=0;i<wave.length;i++){
		wave[i]=[];
	}
	endFlg=new Array(main_img.width*main_img.height);
	for(var i=0;i<endFlg.length;i++){
		endFlg[i]=0;
	}

		for(var yi=0;yi<main_img.height;yi++){
			for(var xi=0;xi<main_img.width;xi++){
				var idx = yi * main_img.width + xi;
				main_img.rgba[idx]=0;
			}
		}
		var x=Math.random()*main_img.width|0;
		var y=Math.random()*main_img.height|0;
		var vx=1;
		var vy=1;
		var poses=[];

		poses.push([x,y]);

		var append=function(x,y){
			var xx = (x+main_img.width) % main_img.width;
			var yy = (y+main_img.height) % main_img.height;
			var idx =yy*main_img.width + xx;
			if(endFlg[idx]){
				return;
			}
			endFlg[idx]=1;
			poses.push([xx,yy]);
			
		}
		var count=0;
		//while(poses.length){
		var f=function(){
			var pos;
			while(poses.length){
				var pos = poses.shift();
				break;
			}
			for(var k=0;k<N;k++){
				append(pos[0]+k-HALF_N,pos[1]-HALF_N);
				append(pos[0]+k-HALF_N,pos[1]+(N-HALF_N-1));
			}
			for(var k=1;k<N-1;k++){
				append(pos[0]-HALF_N,pos[1]+(k-HALF_N));
				append(pos[0]+(N-HALF_N-1),pos[1]+(k-HALF_N));
			}
			getPixel(pos[0],pos[1],main_img,pat_img);
		
		}
		document.addEventListener("keydown",function(e){
			f();
			var ctx =  c.getContext('2d')
			ctx.putImageData(main_img.toImageData(),0,0);
		});
//		for(var i=0;i<256*256;i++){
//			getPixel(x,y,main_img,pat_img);
//			if((i&3)===0){
//				vx=(Math.random()*3|0)-1;
//				vy=(Math.random()*3|0)-1;
//		}
//			x+=vx;
//			y+=vy;
//			x&=(main_img.width-1);
//			y&=(main_img.height-1);
//		
//		}
//		for(var yi=0;yi<main_img.height;yi++){
//			for(var xi=0;xi<main_img.width;xi++){
//				x=xi;
//				y=yi;
//				if(main_img.rgba[y*main_img.width+x]&0xff000000){
//					continue;
//				}
//		//for(var i=0;i<main_img.rgba.length;i++){
//		//	var x=Math.random()*main_img.width|0;
//		//	var y=Math.random()*main_img.height|0;
//
//				getPixel(x,y,main_img,pat_img);
//			}
//			
//		}

		
		var ctx =  c.getContext('2d')
		ctx.putImageData(main_img.toImageData(),0,0);
	}

	var pat = document.getElementById("pat");
	pat.addEventListener("change",function(e){
		act(imgs[this.selectedIndex]);

	});
}

</script>
</head>

<body onLoad="onloadfunc(event)">

	<canvas id="c" width="64" height="64" style="width:256px;height:256px;"></canvas>
	<select id="pat">
	</select><br>
	<img id="img_pat" style="width:128px;height:128px;">
</body>
</html>


