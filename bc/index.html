
<!-- ごくろうさまです -->

<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<title>bc</title>
<link rel="stylesheet" href="main.css">

</head>

<body onLoad="onloadfunc(event)">
	<div style="position:fixed;bottom:0px;right:0px;font-size:8pt;">c20210215_d20210215</div>
<div  class="subwindow" id="subwindow" style="display:none;">
	<div  class="back" onclick="closeSubWindow(null);">
	</div>
	<div style="" class="submain">
		<div bind="subwindow_part"></div>
		<table>
			<thead>
				<tr>
					<!--
					<td><a href="#" onclick="createTable('shiki')">s</a></td>
					-->
					<th style="text-align:right;">sort</td>
					<th><a href="#" onclick="createTable('atk')">攻</a></th>
					<th><a href="#" onclick="createTable('def')">防</a></th>
					<th><a href="#" onclick="createTable('spd')">速</a></th>
					<th><a href="#" onclick="createTable('lp')">体</a></th>
					<th><a href="#" onclick="createTable('bst')">ブ</a></th>
					<th id="category"><a href="#" onclick="createTable('category')">category</a></th>
				</tr>
			</thead>
			<tbody id="subbody">
			</tbody>
		</table>
	</div>

</div>

<!--
	<div class="header">
		<span class="part"></span>
		<span class="buso"></span>
		<span class="rarelity"></span>
		<span class="lv"></span>
		<span class="header atk"></span>
		<span class="header def"></span>
		<span class="header spd"></span>
		<span class="header lp"></span>
		<span class="header bst"></span>
	</div>
	-->

	<div><span class="shinki template_buso" id="shinki" ></span><span class="biko" bind="biko"></span></div>
	<span bind="tekise" class="biko"></span>
	<div style="margin-bottom:4px;">
		<span class="part"></span>
		<span class="rarelity"></span>
		<span class="lv"></span>
		<span style="width:200px;text-align:right;">
			<span>アイコン</span>
			<select id="individual" style="width:100px" bind="shinki.individual">
			</select>
		</span>
		<span class="param" bind="individual">
		</span>
	</div>
	<div><span class="template_buso" id="head" ></span></div>
	<div><span class="template_buso" id="body" ></span></div>
	<div><span class="template_buso" id="arm" ></span></div>
	<div><span class="template_buso" id="leg" ></span></div>
	<div><span class="template_buso" id="rear" ></span></div>
	<div><span class="template_buso" id="weapon"></span></div>
	<div class="sub"><span class="template_buso" id="sub"></div>

	<br>
	<div class="subtotal">
		<span class="part"></span>
		<span class="lv"></span>
		<span class="rarelity"></span>
		<span class="buso">小計</span>
		<span class="param" bind="subtotal"></span>
		<span class="biko" bind="subtotal.biko"></span>
	</div>
	<br>
	<div class="total">
		<span class="part"></span>
		<span class="lv"></span>
		<span class="rarelity"></span>
		<span class="buso">武器適正やパッシブ適用後</span>
		<span class="param" bind="total"></span>
	</div>


<div style="display:none;" id="template">

	<span id="buso" class="hoge">
		<span class="part"></span>
		<select class="buso" >
		</select>
			<span class="name">
		<a bind="name" href="#">
		</a>
			</span>
		<select  class="rarelity" bind="rarelity">
		</select>
		<select class="lv" bind="lv">
			<option value="1">Lv1</option>
			<option value="60">Lv60</option>
		</select>
			
		<span class="param" bind="">
		</span>
		<span class="biko" bind="biko"></span>
	</span>

	<select id="rarelity" class="rarelity" bind="rarelity">
		<option class="N" value="0">N</option>
		<option class="R" value="1">R</option>
		<option class="SR" value="2">SR</option>
		<option class="UR" value="3">UR</option>
	</select>

	<span id="param">
		<span class="status atk" bind="atk">1</span>
		<span class="status def" bind="def">2</span>
		<span class="status spd" bind="spd">3</span>
		<span class="status lp"  bind="lp">4</span>
		<span class="status bst" bind="bst">5</span>
	</span>
</div>

</body>

<script type="text/javascript">
"use strict"

var Bind={};
Bind.binds=[];
Bind.init=function(){
	var bindedNodes = document.querySelectorAll("[bind]");
	for(var i=0;i<bindedNodes.length;i++){
		Bind.bind(bindedNodes[i]);
	}
}

Bind.bind=function(target){
	var bind={};
	bind.target = target;
	bind.variable = bind.target.getAttribute("bind").split(".");
	this.binds.push(bind);
}
Bind.setBindValue=function(target,n){
	const bind = this.binds.find(function(elem){return elem.target ===target});
	var val =this.getBindValue(target,1);
	val[bind.variable[bind.variable.length-1]]=n;
}
Bind.getBindValue=function(target,n){
	var value=values;
	const bind = this.binds.find(function(elem){return elem.target===target});
	for(var j=0;j<bind.variable.length-n;j++){
		value = value[bind.variable[j]];
		if(value == undefined){
			value=null;
			break;
		}
	}
	return value;
}
Bind.refresh=function(){
	for(var i=0;i<this.binds.length;i++){
		const bind = this.binds[i];
		var value = values;
		var target = bind.target;
		for(var j=0;j<bind.variable.length;j++){
			value = value[bind.variable[j]];
			if(value == undefined){
				value="";
				break;
			}
		}
		if(target.tagName==="INPUT" || target.tagName==="SELECT"){
			if(target.value !== value){
				target.value = value;
				var event = new Event('change');
				target.dispatchEvent(event);
			}
		}else{
			target.innerHTML = value;
		}
	}
}

var const_lists=[];
var weapon_categories=[];
var shinki_rarelity_bonus=[
	{atk:0,def:0,spd:0,lp:0,bst:0}
	,{atk:5,def:5,spd:10,lp:50,bst:20}
	,{atk:10,def:10,spd:20,lp:100,bst:40}
	,{atk:15,def:15,spd:30,lp:150,bst:60}
];

var Data={};
Data.passives=[];
Data.shinkis=[];
Data.busos=[];

Data.individuals=[
	{name:"",atk:0,def:0,spd:0,lp:0,bst:0}
];


var reset=function(a){
	for(var i=0;i<const_lists.param_cd.length;i++){
		a[const_lists.param_cd[i]]= 0;
	}
}
var add=function(a,b){
	for(var i=0;i<const_lists.param_cd.length;i++){
		var param_cd = const_lists.param_cd[i];
		a[param_cd] += b[param_cd];
	}
}

var reCalc=function(){
	var passives=[];

	var nodes = document.querySelectorAll("select[bind]");
	for(var i=0;i<nodes.length;i++){
		var node = nodes[i];
		Bind.setBindValue(node,node.value);
	}


	//神姫
	values.default_shinki_param = Data.default_shinki_param;
	var shinki= Data.shinkis.find(function(elem){return elem.cd === values.shinki.cd});
	if(shinki){
		reset(values.shinki);
		add(values.shinki,shinki);
		values.shinki.name=shinki.name;

		//レアリティ
		var rare = values.shinki.rarelity;
		add(values.shinki,shinki_rarelity_bonus[rare]);

		var ap="";
		for(var i=0;i<shinki.apts.length;i++){
			var hose= shinki.apts[i];
			if(hose !==0){

				if(hose===100){
					hose-=20*rare;
				}else if(hose<0){
					hose+=5*rare;
				}else{
					hose-=5*rare;
				}
				if(hose>0){
					ap += "<span class='apt'>[";
				}else{
					ap += "<span class='apt_'>[";
				}
				ap +=  weapon_categories[i].short_name + "]"+hose+"%</span>";
			}
		}
		values.tekise=ap;
	}
	//アイコン
	values.individual= Data.individuals[values.shinki.individual];

	//武装
	for(var i=1;i<const_lists.part_cd.length;i++){
		var part=const_lists.part_cd[i];
		var r = Number(values[part].rarelity);
		var lv= values[part].lv;
		var cd = values[part].cd;

		var idx = Data.busos.findIndex(function(elem){return elem.cd === cd;});
		reset(values[part]);
		values[part].biko = "";
		if(idx<0){
	 		continue;
	  }
		var buso = Data.busos[idx];
		if(buso.rarelity !== r){
			var idx2 = idx + r -buso.rarelity;
			if(Data.busos[idx2].name === buso.name){
				values[part].cd = buso.cd;
				buso = Data.busos[idx2];
			}else{
				values[part].rarelity = buso.rarelity;
			}
		}
		values[part].name=buso.name;
	  	if(buso.part===6){
			values[part].name=buso.name + "[" +weapon_categories[buso.category].short_name +"]";
		}
		add(values[part],buso);
		if(lv==60){
			var bonus;
			if(buso.part===6){
				if(part.range===0){
					bonus= Data.lv_bonus.weapon_short[r];
				}else{
					bonus= Data.lv_bonus.weapon_long[r];
				}
			}else{
				bonus= Data.lv_bonus[part][r];
			}
			add(values[part],bonus);
		}
		if(buso.passive>0){
			values[part].biko = "<span class='passive'>" + Data.passives[buso.passive].name + "</span>";

			passives.push(Data.passives[buso.passive]);
		}
		if(buso.active>0){
			values[part].biko = "<span class='active'>" + Data.actives[buso.active].name + "</span>";

		}
	}

	var total=values.subtotal;
	reset(total);
	add(total,values.shinki);
	add(total,values.individual);
	add(total,values.head);
	add(total,values.body);
	add(total,values.arm);
	add(total,values.leg);
	add(total,values.rear);
	add(total,values.weapon);
	

	var total2=values.total;
	values.total=total2;
	reset(total2);

	var weapon= Data.busos.find(function(elem){return elem.cd === values.weapon.cd});
	var hose = shinki.apts[weapon.category];
	add(total2,total);

	//passive
	values.subtotal.biko ="";
	if(hose!==0){
		if(hose===100){
			hose-=20*rare;
		}else if(hose<0){
			hose+=5*rare;
		}else{
			hose-=5*rare;
		}
		total2.atk += Math.trunc(total2.atk * hose*0.01);
		if(hose>0){
			values.subtotal.biko += "<span class='apt'>[" + weapon_categories[weapon.category].short_name + "]"+hose+"%</span>";
		}else{
			values.subtotal.biko += "<span class='apt_'>[" + weapon_categories[weapon.category].short_name + "]"+hose+"%</span>";
		}
	}
	for(var i=0;i<passives.length;i++){
		values.subtotal.biko += "<span class='passive'>" + passives[i].name +"</span>";
		if(passives[i].func){
			passives[i].func(values);
		}
	}

	Bind.refresh();
}

var values={total:{},subtotal:{}};
window.onloadfunc=function(){
for(var i=0;i<const_lists.part_cd.length;i++){
	values[const_lists.part_cd[i]]={};
	values[const_lists.part_cd[i]].rarelity=0;
}

	//部位ごとの武装フォーム作成
	var divs= document.querySelectorAll(".template_buso");
	var divbuso=document.querySelector("#template #buso");
	for(var i=0;i<divs.length;i++){
		var org = divs[i];
		var part = org.id;
		if(org === divbuso)continue;
		var div2 = divbuso.cloneNode(true);

		div2.id = org.id;
		div2.querySelector("select.buso").id="buso_"+org.id;
		div2.classList.add(org.id);
		div2.querySelector("select.rarelity").id=org.id+"_rarelity";
		div2.querySelector("select.lv").id=org.id+"_lv";

		var children = div2.querySelectorAll("[bind]");
		for(var j=0;j<children.length;j++){
			children[j].setAttribute("bind",part+"."+children[j].getAttribute("bind"));
		}
		div2.querySelector("span.param").setAttribute("bind",part);


		org.parentNode.replaceChild(div2,org);
	}

	//param
	var nodes= document.querySelectorAll("span.param");
	var param= document.getElementById("param");
	for(var i=0;i<nodes.length;i++){
		var node = nodes[i];
		var newnode = param.cloneNode(true);
		var bindName = node.getAttribute("bind");
		var children = newnode.querySelectorAll("[bind]");
		for(var j=0;j<children.length;j++){
			children[j].setAttribute("bind",bindName +"."+children[j].getAttribute("bind"));
		}

		node.parentNode.replaceChild(newnode,node);
	}

	//レアリティコンボボックス設定
	var rarelity_label=["N","R","SR","UR"];
	var selects = document.querySelectorAll("select.rarelity");
	var rare = document.getElementById("rarelity");
	for(var i=0;i<selects.length;i++){
		var rare2 = rare.cloneNode(true);
		var org = selects[i];
		rare2.addEventListener("change",function(){
			var div = this.parentNode;
			for(var j=0;j<rarelity_label.length;j++){
				div.classList.remove(rarelity_label[j]);
			}
			div.classList.add(rarelity_label[this.selectedIndex]);
		});
		if(org.getAttribute("bind") !== null){
			rare2.setAttribute("bind",org.getAttribute("bind"));
		}
		org.parentNode.replaceChild(rare2,org);
	}

	//部位ごとの武装セット
	for(var i=0;i<const_lists.part_cd.length;i++){
		var part=const_lists.part_cd[i];
		var select= document.getElementById("buso_"+part);
		for(var j=0;j<Data.busos.length;j++){
			var buso = Data.busos[j];
			if(buso.part !== i && !(buso.part===6 && i===7)){continue;};
	  		if(buso.rarelity !== 0 || buso.name ==="-"){continue;};
			values[part].cd=buso.cd;
	  		break;
		}
	  
		var f=(function(part){
			return function(e){
				var target = e.currentTarget;
	  			var target =const_lists.part_cd[part];
				var rarelity = values[target].rarelity;
	  			if(part===7){ part=6 }

				values.subwindow_part="【"+const_lists.part_name[part]+"】";
				Bind.refresh();
				openSubWindow(target,part,Number(rarelity));
				e.preventDefault();
				return false;
			}
		})(i);
		
		var span = select.parentNode.querySelector(".name");
		span.addEventListener("click",f);

	}
	values.shinki.cd=Data.shinkis[0].cd;

	Bind.init();


	var nodes= document.querySelectorAll("select");
	for(var i=0;i<nodes.length;i++){
		nodes[i].addEventListener("change",function(){
			reCalc();
		});
	}

	var select = document.querySelector("#individual");
	for(var i=0;i<Data.individuals.length;i++){
		var individual= Data.individuals[i];
		var option = document.createElement("OPTION");
		option.innerHTML = individual.name;
		option.value= i;
		select.appendChild(option);
	}

	document.querySelector("#shinki_lv").setAttribute("disabled","disabled");

	reCalc();

}

var conv=function(row,n){
	var buso = {};

	buso.part=n;
	buso.set=row[0];
	buso.class = row[1];
	buso.name=row[2];
	buso.rarelity=row[3];
	buso.atk=row[4];
	buso.def=row[5];
	buso.spd=row[6];
	buso.lp=row[7];
	buso.bst=row[8];
	buso.passive=row[9];
	buso.effect=row[10];
	buso.biko=row[11];
	return buso;
}

function prepareData(data){

	var keys = Object.keys(data);

	//省略セルデータ補間
	for(var i=0;i<keys.length;i++){
		if(keys[i]==="lists"){
			continue;
		}
		var list = data[keys[i]];
		for(var j=1;j<list.length;j++){
			var row = list[j];
			for(var k=0;k<row.length;k++){
				if(row[k]==="" || row[k]==="#N/A"){
					row[k]=list[j-1][k];
				}
			}
		}
		
	}
	//名称リスト
	const_lists=[];
	var lists = data.lists;
	for(var i=0;i<lists[0].length;i++){
		var list=[];
		for(var j=1;j<lists.length;j++){
			if(lists[j][i] ==="")break;
			list.push(lists[j][i]);
		}
		const_lists[lists[0][i]]=list;

	}

	//神姫
	for(var i=0;i<data.shinki.length;i++){
		var row = data.shinki[i];
		var shinki= {};

		shinki.cd="shinki_"+i;
		shinki.name=row[0];
		shinki.rarelity=row[1];
		shinki.atk=row[2];
		shinki.def=row[3];
		shinki.spd=row[4];
		shinki.lp=row[5];
		shinki.bst=row[6];
		shinki.apts=row.slice(7,7+15);
		shinki.apts.unshift(0);
		Data.shinkis.push(shinki);
	}
	//アイコン補正
	for(var i=0;i<data.individuals.length;i++){
		var row = data.individuals[i];
		var individual= {};
		individual.name=row[0];
		individual.atk=row[1];
		individual.def=row[2];
		individual.spd=row[3];
		individual.lp=row[4];
		individual.bst=row[5];
		Data.individuals.push(individual);
	}
	//武装
	for(var j=1;j<6;j++){
		var part=const_lists.part_cd[j];
		var part_data= data[part];
		if(!part_data)continue;
		for(var i=0;i<part_data.length;i++){
			var row = part_data[i];
			var buso = conv(row,j);
			buso.cd=part+"_"+i;
			Data.busos.push(buso);
		}
	}


	//武器カテゴリ
	for(var j=0;j<data.weapon_categories.length;j++){
		var cat ={}
		cat.name=data.weapon_categories[j][0];
		cat.short_name=data.weapon_categories[j][1];
		weapon_categories.push(cat);
	}

	//武器
	var part_data= data.weapon;
	for(var i=0;i<part_data.length;i++){
		var row = part_data[i];
		var buso = conv(row,6);
		buso.cd="weapon_"+i;
		buso.passive=-1;
		buso.active=row[9];
		buso.category=row[12];
		buso.range=row[13];
		Data.busos.push(buso);
	}

	//パッシブ
	for(var i=0;i<data.passive.length;i++){
		var passive={};
		passive.name=data.passive[i][0];
		Data.passives.push(passive);
	}
	var correctStatus=(atk,def,spd,lp,bst)=>{
	   values.total.atk += Math.trunc(values.subtotal.atk * 0.01*atk);
	   values.total.def += Math.trunc(values.subtotal.def * 0.01*def);
	   values.total.spd += Math.trunc(values.subtotal.spd * 0.01*spd);
	   values.total.lp  += Math.trunc(values.subtotal.lp  * 0.01*lp);
	   values.total.bst += Math.trunc(values.subtotal.bst * 0.01*bst);
	}
	Data.passives[ 1].func=function(effect){ correctStatus(1+effect,0,0,0,0); }
	Data.passives[ 2].func=function(effect){ correctStatus(0,1+effect,0,0,0); }
	Data.passives[ 3].func=function(effect){ correctStatus(0,0,1+effect,0,0); }
	Data.passives[ 4].func=function(effect){ correctStatus(0,0,0,1+effect,0); }
	Data.passives[ 5].func=function(effect){ correctStatus(0,0,0,0,1+effect); }
	Data.passives[ 6].func=function(effect){ correctStatus(effect,effect,effect,effect,effect); }

	//アクティブ
	Data.actives=[];
	for(var i=0;i<data.active.length;i++){
		var active={};
		active.name=data.active[i][0];
		Data.actives.push(active);
	}

	//レベル増加値
	Data.lv_bonus={};
	var sheet_data = data.lv_bonus;
	for(var i=0;i<sheet_data.length;){
		var bonuses=[];
		var part = sheet_data[i][0];
		for(var j=0;j<4;j++){
			var bonus={};
			var row = data.lv_bonus[i];
			bonus.atk=row[3];
			bonus.def=row[4];
			bonus.spd=row[5];
			bonus.lp =row[6];
			bonus.bst=row[7];
			bonuses.push(bonus);
			i++;
		}
		Data.lv_bonus[part] = bonuses;
	}

}

	  var sub_target=null;
	  var openSubWindow=function(target,part,rarelity){
	  		sub_target=target;

			var data =[];
	  		if(part===0){
				for(var i=0;i<Data.shinkis.length;i++){
					var buso = Data.shinkis[i];
					data.push(buso);

				}
		 	}else{
				for(var i=0;i<Data.busos.length;i++){
					var buso = Data.busos[i];
					if(buso.part !== part || buso.rarelity !==rarelity){
						continue;
					}
					data.push(buso);
				}
	 		}
	  		values.table_data= data;
			createTable();
			var subwindow= document.querySelector("#subwindow");
			subwindow.style.display="block";
	  }

	var closeSubWindow=(e)=>{
		var subwindow= document.querySelector("#subwindow");
		subwindow.style.display="none";

		if(e===null){
			return;
		}

		var h=e.currentTarget.parentNode.querySelector(".hidden");
		values[sub_target].cd = h.innerHTML;

		reCalc();
	}

var createTable=function(sort_member){
	var data= values.table_data;
	if(sort_member !== null){
		if(values.old_sort === sort_member){
			data.sort(function(a,b){return a[sort_member]- b[sort_member];});
			values.old_sort="!" + sort_member;
		}else{
			data.sort(function(a,b){return -a[sort_member]+ b[sort_member];});
			values.old_sort= sort_member;
		}
	}
	var tbody = document.querySelector("#subbody");
	tbody.innerHTML="";
	var category_flg=false;
	for(var i=0;i<data.length;i++){
		var buso = data[i];
		var tr,td,a;
		tr = document.createElement("tr");

//		td = document.createElement("td");
//		td.innerHTML ="aaa";// weapon_categories[ buso.shinki].name;
//		tr.appendChild(td);
		
		td = document.createElement("td");
		td.className="name";
		a= document.createElement("a");
		a.setAttribute("href","#");
		a.onclick=closeSubWindow;
		var hidden= document.createElement("span");
		hidden.className="hidden";
		hidden.innerHTML =buso.cd;
		

		a.innerHTML = buso.name;
		a.appendChild(hidden);
		td.appendChild(a);
		tr.appendChild(td);

		for(var j=0;j<const_lists.param_cd.length;j++){
			var param_cd = const_lists.param_cd[j];
			td = document.createElement("td");
			var span= document.createElement("span");
			span.className="status "+param_cd;
			span.innerHTML = buso[param_cd];
	  		td.appendChild(span);
			tr.appendChild(td);
		}
		if(buso.category !== undefined){
			td = document.createElement("td");
			td.innerHTML = "[" + weapon_categories[ buso.category].name + "]";
			tr.appendChild(td);
			category_flg=true;
		}
		tbody.appendChild(tr);
	}
	  if(category_flg){
	  	document.querySelector("th#category").style.display="inherit";
	  }else{
	  	document.querySelector("th#category").style.display="none";
	  }
}

</script>
<script type="text/javascript" src="./data.js"></script>
<!--
<script type="text/javascript" src="https://script.google.com/macros/s/AKfycbx-WLdGV8_s5s3Cus5xIltvzh76ML8EnPhmP2pX0t4/dev?callback=prepareData"></script>
-->
</html>


