<!-- ごくろうさまです -->

<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<title>bcassembly</title>
<link rel="stylesheet" href="main.css">
</head>

<body onload="onloadfunc()">
<div id="form">
<div style="position:fixed;bottom:0px;right:0px;font-size:8pt;">c20210215_d20210215</div>

<div  class="subwindow" id="subwindow" style="display:none;">
	<div  class="back" onclick="closeSubWindow(null);">
	</div>
	<div style="" class="submain">
		<div><input class="filter" bind="filter_sort" onchange="{values.filter_sort=this.value;createTable();}";>
		</div>
		<table>
			<thead id="sub_head">
				<tr>
				</tr>
				<tr>
				</tr>
			</thead>
			<tbody id="sub_body">
				<tr>
				</tr>
			</tbody>
		</table>
	</div>
</div>

	<div><span class="shinki template_part" id="shinki" ></span><span class="biko" bind="biko"></span></div>
	<span bind="tekise" class="biko"></span>
	<div style="margin-bottom:4px;">
		<span class="" style="width:80px;display:inline-block;"></span>
		<span class="rarelity"></span>
		<span class="lv"></span>
		<span style="width:200px;text-align:right;">
			<span>アイコン</span>
			<select id="individual" style="width:100px" bind="shinki.individual">
			</select>
		</span>
		<span class="param" bind="individual">
		</span>
	</div>
	<div><span class="template_part" id="head" ></span></div>
	<div><span class="template_part" id="body" ></span></div>
	<div><span class="template_part" id="arm" ></span></div>
	<div><span class="template_part" id="leg" ></span></div>
	<div><span class="template_part" id="rear" ></span></div>
	<div><span class="template_part" id="weapon"></span></div>
	<div class="sub"><span class="template_part" id="sub"></div>

	<br>
	<div>
		<span class="" style="width:80px;display:inline-block;"></span>
		<span class="lv"></span>
		<span class="rarelity"></span>
		<span class="buso">小計</span>
		<span class="param" bind="subtotal"></span>
		<span class="biko" bind="subtotal.biko"></span>
	</div>
	<br>
	<div>
		<span class="" style="width:80px;display:inline-block;"></span>
		<span class="lv"></span>
		<span class="rarelity"></span>
		<span class="buso">武器適正やパッシブ適用後</span>
		<span class="param" bind="total"></span>
	</div>

</div>

<div style="display:none;" id="template">

	<span id="buso">
		<span class="part"></span>
		<span class="name">
			<span bind=".name" class="onclick"></span>
		</span>
		<select  class="rarelity" bind=".rarelity">
		</select>
		<select class="lv" bind=".lv">
			<option value="1">Lv1</option>
			<option value="60">Lv60</option>
		</select>
			
		<span class="param" bind="">
		</span>
		<span class="biko" bind=".biko"></span>
	</span>

	<select id="rarelity" class="rarelity" bind="rarelity">
		<option class="N" value="0">N</option>
		<option class="R" value="1">R</option>
		<option class="SR" value="2">SR</option>
		<option class="UR" value="3">UR</option>
	</select>

	<span id="param">
		<span class="status atk" bind=".atk">1</span>
		<span class="status def" bind=".def">2</span>
		<span class="status spd" bind=".spd">3</span>
		<span class="status lp"  bind=".lp">4</span>
		<span class="status bst" bind=".bst">5</span>
	</span>
</div>

</body>

<script type="text/javascript">
"use strict";

var values={total:{},subtotal:{}};

var reset=function(a){
	for(var i=0;i<Data.param_cd.length;i++){
		a[Data.param_cd[i]]= 0;
	}
}
var add=function(a,b){
	for(var i=0;i<Data.param_cd.length;i++){
		var param_cd = Data.param_cd[i];
		a[param_cd] += b[param_cd];
	}
}

var reCalc=function(){
	//計算処理
	var passives=[];

	var nodes = document.querySelectorAll("#form select[bind]");
	for(var i=0;i<nodes.length;i++){
		var node = nodes[i];
		const bind = Bind.binds.find(function(elem){return elem.target ===node});
		if(!bind)continue;
		Bind.setBindValue(bind,node.value);
	}

	//神姫
	values.default_shinki_param = Data.default_shinki_param;
	var shinki= Data.shinkis.find(function(elem){return elem.cd === values.shinki.cd});
	if(!shinki){return;}
	reset(values.shinki);
	add(values.shinki,shinki);
	values.shinki.name=shinki.name;

	//レアリティ
	var rare = values.shinki.rarelity;
	add(values.shinki,Data.shinki_rarelity_bonus[rare]);

	values.shinki.apts=[];
	for(var i=0;i<shinki.apts.length;i++){
		var apt={};
		var effect= shinki.apts[i];
		if(effect!==0){
			apt.weapon_category = i;
			if(effect===100){
				effect-=20*rare;
			}else if(effect<0){
				effect+=5*rare;
			}else{
				effect-=5*rare;
			}
			apt.effect = effect;
			values.shinki.apts.push(apt);
		}
	}
	var ap="";
	for(var i=0;i<values.shinki.apts.length;i++){
		var apt=values.shinki.apts[i];
		if(apt.effect>0){
			ap += "<span class='apt'>";
		}else{
			ap += "<span class='apt_'>";
		}
		ap +=  "[" +Data.categories[apt.weapon_category].short_name + "]"+apt.effect+"%</span>";
	}
	values.tekise=ap;
	
	//アイコン補正
	values.individual= Data.individuals[values.shinki.individual];

	//武装
	for(var i=1;i<Data.part_cd.length;i++){
		var part=Data.part_cd[i];
		var r = Number(values[part].rarelity);
		var lv= values[part].lv;
		var cd = values[part].cd;

		var idx = Data.busos.findIndex(function(elem){return elem.cd === cd;});
		reset(values[part]);
		values[part].biko = "";
		if(idx<0){
	 		continue;
	  }
		var buso = Data.busos[idx];
		if(buso.rarelity !== r){
			var idx2 = idx + r -buso.rarelity;
			if(Data.busos[idx2].name === buso.name){
				values[part].cd = buso.cd;
				buso = Data.busos[idx2];
			}else{
				values[part].rarelity = buso.rarelity;
			}
		}
		values[part].org = buso;

		values[part].name=buso.name;
	  	if(buso.part===6){
			values[part].name=buso.name + "[" +Data.categories[buso.category].short_name +"]";
		}
		add(values[part],buso);
		if(lv==60){
			var bonus;
			if(buso.part===6){
				if(part.range===0){
					bonus= Data.lv_bonus.weapon_short[r];
				}else{
					bonus= Data.lv_bonus.weapon_long[r];
				}
			}else{
				bonus= Data.lv_bonus[part][r];
			}
			add(values[part],bonus);
		}
		if(buso.passive>0){
			var passive={};
			passive.cd = buso.passive;
			passive.effect= buso.effect;
			passives.push(passive);
			values[part].biko = "<span class='passive'>" + Data.passives[passive.cd].name ;
			if(passive.effect>0){
				values[part].biko += "[" + Data.effect[passive.effect]+"]";
			}
			values[part].biko += "</span>";
		}
		if(buso.active>0){
			values[part].biko = "<span class='active'>" + Data.actives[buso.active].name + "</span>";
			if(buso.effect>0){
				values[part].biko += "[" + Data.effect[buso.effect]+"]";
			}
		}
	}

	//小計
	reset(values.subtotal);
	add(values.subtotal,values.shinki);
	add(values.subtotal,values.individual);
	add(values.subtotal,values.head);
	add(values.subtotal,values.body);
	add(values.subtotal,values.arm);
	add(values.subtotal,values.leg);
	add(values.subtotal,values.rear);
	add(values.subtotal,values.weapon);
	
	//最終値
	reset(values.total);
	add(values.total,values.subtotal);

	values.subtotal.biko ="";
	//適性補正
	for(var i=0;i<values.shinki.apts.length;i++){
		var apt=values.shinki.apts[i];
		if(apt.weapon_category !== values.weapon.org.category)continue;
		var str="";
		if(apt.effect>0){
			str+= "<span class='apt'>";
		}else{
			str+= "<span class='apt_'>";
		}
		str +=  "[" + Data.categories[apt.weapon_category].short_name + "]"+apt.effect+"%</span>";
		values.total.atk += Math.trunc(values.subtotal.atk * apt.effect*0.01);
		values.subtotal.biko +=str;
	}
	//パッシブ補正
	for(var i=0;i<passives.length;i++){
		var passive =passives[i];
		values.subtotal.biko += "<span class='passive'>" + Data.passives[passive.cd].name ;
		if(passive.effect>0){
			values.subtotal.biko += "[" + Data.effect[passive.effect]+"]";
		}
		values.subtotal.biko += "</span>";
		if(Data.passives[passive.cd].func){
			Data.passives[passive.cd].func(passive.effect);
		}
	}

	Bind.refresh();
}


var onloadfunc=function(){

	//部位ごとのフォーム作成
	var targets= document.querySelectorAll(".template_part");
	var template=document.querySelector("#template #buso");
	for(var i=0;i<targets.length;i++){
		var target = targets[i];
		var part_cd = target.id;
		var part_idx = Data.part_cd.findIndex(function(e){return e===part_cd;});
		if(part_idx===7){part_idx=6;};

		var clone = template.cloneNode(true);

		clone.id = target.id;
		clone.classList.add(target.id);

		var children = clone.querySelectorAll("[bind]");
		for(var j=0;j<children.length;j++){
			children[j].setAttribute("bind",part_cd+children[j].getAttribute("bind"));
		}
		 clone.querySelector(".part").textContent = Data.part_name[i];
 
		var span = clone.querySelector(".name *");
		span.addEventListener("click"
			,(function(part_cd,part_idx){
				return function(e){
					openSubWindow(part_cd,part_idx,Number(values[part_cd].rarelity));
					e.preventDefault();
					return false;
				}
		})(part_cd,part_idx));

		target.parentNode.replaceChild(clone,target);
	}

	//param
	var nodes= document.querySelectorAll("span.param");
	var param= document.getElementById("param");
	for(var i=0;i<nodes.length;i++){
		var node = nodes[i];
		var newnode = param.cloneNode(true);
		var bindName = node.getAttribute("bind");
		var children = newnode.querySelectorAll("[bind]");
		for(var j=0;j<children.length;j++){
			children[j].setAttribute("bind",bindName +children[j].getAttribute("bind"));
		}

		node.parentNode.replaceChild(newnode,node);
	}

	//レアリティコンボボックス設定
	var selects = document.querySelectorAll("select.rarelity");
	var rare = document.getElementById("rarelity");
	for(var i=0;i<selects.length;i++){
		var rare2 = rare.cloneNode(true);
		var org = selects[i];
		rare2.id="";
		rare2.addEventListener("change",function(){
			var div = this.parentNode;
			for(var j=0;j<Data.rarelity.length;j++){
				div.classList.remove(Data.rarelity[j]);
			}
			div.classList.add(Data.rarelity[this.selectedIndex]);
		});
		if(org.getAttribute("bind") !== null){
			rare2.setAttribute("bind",org.getAttribute("bind"));
		}
		org.parentNode.replaceChild(rare2,org);
	}

	//初期値セット
	values.shinki={};
	values.shinki.cd=Data.shinkis[0].cd;

	for(var i=1;i<Data.part_cd.length;i++){
		values[Data.part_cd[i]]={};
		var part=values[Data.part_cd[i]];
		var part_idx = i;
		if(part_idx=== 7){ part_idx=6;};
		part.rarelity=0;
		part.cd=Data.busos.find(function(e){
	  		return e.part===part_idx && e.name !=="-" && e.rarelity === 0}).cd;
	}

	Bind.init();

	var nodes= document.querySelectorAll("select");
	for(var i=0;i<nodes.length;i++){
		nodes[i].addEventListener("change",function(){
			reCalc();
		});
	}

	var select = document.querySelector("#individual");
	var data = Data.individuals;
	for(var i=0;i<data.length;i++){
		var option = document.createElement("OPTION");
		option.textContent = data[i].name;
		option.value= i;
		select.appendChild(option);
	}
	

	document.querySelector("span#shinki .lv").setAttribute("disabled","disabled");

	reCalc();

}


//サブ画面ーーーーーーーーーーーーーーーーーー
var sub_target=null;
var sub_header=[];
var table_data=[];
var table_sorter=[];
var openSubWindow=function(target,part,rarelity){
	sub_target=target;
	values.filter ="";
	
	sub_header=[{label:"name",data:"name"}
		,{data:"atk",label:"攻"}
		,{data:"def",label:"防"}
		,{data:"spd",label:"速"}
		,{data:"lp", label:"体"}
		,{data:"bst",label:"ブ"}];
		if(part===0){
			table_data = Data.shinkis;
			values.filter={};
		}else{
			sub_header.splice(0,0,{data:"rarelity",label:"R",disp:function(e){
				return Data.rarelity[e.rarelity];}}); 
			sub_header.unshift({data:"part",disp:function(e){return Data.part_name[e.part]}});
			sub_header.unshift({data:"class",label:"分類",disp:function(e){return Data.class[e.class];}});
			if(part===6){
				sub_header.splice(4,0,{data:"category",label:"カテゴリ",disp:function(e){
					return Data.categories[e.category].short_name;}}); 
				sub_header.push({data:"active",disp:function(e){
						if(Data.actives[e.active]){
							return Data.actives[e.active].name + (e.effect?"["+Data.effect[e.effect]+"]":"");}}}); 
						

			}else{
				sub_header.push({data:"passive",disp:function(e){
					if(e.passive>=0){

						return Data.passives[e.passive].name + (e.effect?"["+Data.effect[e.effect]+"]":"");}}}); 
			}
			if(part===5){
				sub_header.push({data:"flying",label:"飛行",disp:function(e){return Data.flying[e.flying]}});
			}
			values.filter={part:[part],rarelity:[rarelity]};
			table_data = Data.busos;
		}
		values.sort=[];

		//ヘッダ作る
		var tr = document.createElement("tr");
		var tr2 = document.createElement("tr");
		tr2.classList.add("filter");
		sub_header.forEach(function(header){
			var th = document.createElement("th");

			var a= document.createElement("span");
			a.textContent="terst";
			a.setAttribute("bind","filter_name."+header.data);
			a.onclick=(function(cd){return function(e){setFilter(cd,null);}})(header.data);
			th.appendChild(a);
			th.classList.add(header.data);
			tr2.appendChild(th);

			th = document.createElement("th");
			a= document.createElement("span");
			a.textContent=header.label?header.label:header.data;
			a.classList.add("onclick");
			a.onclick=(function(cd){return function(e){setSort(cd);}})(header.data);
			th.appendChild(a);

			th.classList.add(header.data);
			tr.appendChild(th);
		});
		var header = document.querySelectorAll("#sub_head tr");
		header[0].parentNode.replaceChild(tr2,header[0]);
		header[1].parentNode.replaceChild(tr,header[1]);

	  	Bind.init();

		createTable();
		var subwindow= document.querySelector("#subwindow");
		subwindow.style.display="block";
  }

var closeSubWindow = function(e){
	var subwindow= document.querySelector("#subwindow");
	subwindow.style.display="none";

	if(e===null){ return; }
	if(sub_target !== 'shinki'){
		var buso = Data.busos.find(function(elem){return elem.cd === e;});
		if(buso){
			values[sub_target].cd = buso.cd ;
			values[sub_target].rarelity = buso.rarelity;
		}

	}else{
		values[sub_target].cd = e;
	}
	Bind.refresh();
	reCalc();
}

var setFilter=function(name,value){
	var filter = values.filter;
	if(!value){
		delete filter[name];
	}else{
		filter[name]=value;
	}

	createTable();
}
var setSort=function(data){
	//var filter_sort = JSON.parse(values.filter_sort);
	var sort = values.sort;

	var idx = sort.indexOf(data);
	if(idx<0){
		idx = sort.indexOf("!"+data);
	}else{
		data = "!"+data;
	}
	if(idx>=0){
		sort.splice(idx,1);
	}else{
		if(["atk","def","spd","lp","bst"].indexOf(data)>=0){
			data = "!"+data;
		}
	}
	sort.unshift(data);
	createTable();

}
var createTable=function(sort_member){

	//var filter_sort = JSON.parse(values.filter_sort);
	var filters = values.filter;
	var sort = values.sort;
	var keys = Object.keys(filters);
	//フィルタ
	var data= table_data.filter(function(e){
		var flg=true;
		keys.forEach(function(key){
			flg &= (filters[key].indexOf(e[key])>=0);
		});
		return flg;
	});

	values.filter_name=[];
	sub_header.forEach(function(header){
		var content= filters[header.data];
		if(content){
			var a = {};a[header.data]=content;
			values.filter_name[header.data]= typeof header.disp == "function"?header.disp(a):content;
		}else{
			values.filter_name[header.data]= "";
		}
	});

	
	//ソート
	data.sort(function(a,b){
		var result=0;
		sort.some(function(e){
		
			if(e.indexOf("!")!=0){
				result =a[e]> b[e]?1:-1;
			}else{
				e = e.substr(1);
				result =a[e]< b[e]?1:-1;
			}
			if(a[e] !== b[e]){return true;}
		});
		return result;
	});


//ボディ作る
	var tbody = document.querySelector("#sub_body");
	tbody.innerHTML="";
	for(var i=0;i<data.length;i++){
		var rowdata = data[i];
		var tr;
		tr = document.createElement("tr");

		sub_header.forEach(function(header){
			var content =  typeof header.disp == "function"?header.disp(rowdata):rowdata[header.data];
			var td = document.createElement("td");
			td.className =header.data;
			if(header.data ==='name'){
				var a= document.createElement("span");
				a.classList.add("onclick");
				a.textContent = content;
				if(rowdata.rarelity){
					a.className =Data.rarelity[rowdata.rarelity];
				}
				a.onclick=(function(cd){return function(e){closeSubWindow(cd);}})(rowdata.cd);
				td.appendChild(a);
			}else if(['atk','def','spd','lp','bst'].indexOf(header.data)>=0){
				var span= document.createElement("span");
				span.className="status "+header.data;
				span.textContent = content;
				td.appendChild(span);
			}else{
				var a= document.createElement("span");
				a.classList.add("filtertarget");
				a.textContent = content;
				a.onclick=(function(cd,value){return function(e){setFilter(cd,[value]);}})(header.data,rowdata[header.data]);
				td.appendChild(a);
			}
			td.setAttribute("title",content);
			tr.appendChild(td);
		});
		tbody.appendChild(tr);
	}
	Bind.refresh();
}

//バインドーーーーーーーーーーーーーーーーーーーーー
var Bind={};
Bind.binds=[];
Bind.init=function(){
	Bind.binds=[];
	var bindedNodes = document.querySelectorAll("#form [bind]");
	for(var i=0;i<bindedNodes.length;i++){
		Bind.bind(bindedNodes[i]);
	}
}

Bind.bind=function(target){
	var bind={};
	bind.target = target;
	bind.variable = bind.target.getAttribute("bind").split(".");
	this.binds.push(bind);
}
Bind.setBindValue=function(bind,n){
	var val =this.getBindValue(bind,1);
	val[bind.variable[bind.variable.length-1]]=n;
}
Bind.getBindValue=function(bind,n){
	var value=values;
	for(var j=0;j<bind.variable.length-n;j++){
		value = value[bind.variable[j]];
		if(value == undefined){
			value=null;
			break;
		}
	}
	return value;
}
Bind.refresh=function(){
	for(var i=0;i<this.binds.length;i++){
		const bind = this.binds[i];
		var value = this.getBindValue(bind,0);
		if(bind.old_value  === value){continue;}
		var target = bind.target;
		if(target.tagName==="INPUT" || target.tagName==="SELECT"){
			if(target.value !== value){
				target.value = value;
				//var event = new Event('change');
				//target.dispatchEvent(event);
			}
		}else{
			target.innerHTML = value;
		}
		bind.old_value = value;
	}
}

</script>
<script type="text/javascript" src="./data.js"></script>
</html>


